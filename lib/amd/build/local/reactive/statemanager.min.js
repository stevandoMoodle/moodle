define("core/local/reactive/statemanager",["exports"],(function(_exports){function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(target,property,receiver){var base=_superPropBase(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(arguments.length<3?target:receiver):desc.value}},_get.apply(this,arguments)}function _superPropBase(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=_getPrototypeOf(object)););return object}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function _wrapNativeSuper(Class){var _cache="function"==typeof Map?new Map:void 0;return _wrapNativeSuper=function(Class){if(null===Class||(fn=Class,-1===Function.toString.call(fn).indexOf("[native code]")))return Class;var fn;if("function"!=typeof Class)throw new TypeError("Super expression must either be null or a function");if(void 0!==_cache){if(_cache.has(Class))return _cache.get(Class);_cache.set(Class,Wrapper)}function Wrapper(){return _construct(Class,arguments,_getPrototypeOf(this).constructor)}return Wrapper.prototype=Object.create(Class.prototype,{constructor:{value:Wrapper,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(Wrapper,Class)},_wrapNativeSuper(Class)}function _construct(Parent,args,Class){return _construct=_isNativeReflectConstruct()?Reflect.construct:function(Parent,args,Class){var a=[null];a.push.apply(a,args);var instance=new(Function.bind.apply(Parent,a));return Class&&_setPrototypeOf(instance,Class.prototype),instance},_construct.apply(null,arguments)}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}function _slicedToArray(arr,i){return function(arr){if(Array.isArray(arr))return arr}(arr)||function(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}
/**
   * Reactive simple state manager.
   *
   * The state manager contains the state data, trigger update events and
   * can lock and unlock the state data.
   *
   * This file contains the three main elements of the state manager:
   * - State manager: the public class to alter the state, dispatch events and process update messages.
   * - Proxy handler: a private class to keep track of the state object changes.
   * - StateMap class: a private class extending Map class that triggers event when a state list is modifed.
   *
   * @module     core/local/reactive/stateManager
   * @class     core/local/reactive/stateManager
   * @copyright  2021 Ferran Recio <ferran@moodle.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0;var StateManager=function(){function StateManager(dispatchEvent,target){var _this=this;_classCallCheck(this,StateManager),this.dispatchEvent=dispatchEvent,this.target=null!=target?target:document,this.readonly=!1,this.eventsToPublish=[],this.updateTypes={create:this.defaultCreate.bind(this),update:this.defaultUpdate.bind(this),delete:this.defaultDelete.bind(this),put:this.defaultPut.bind(this),override:this.defaultOverride.bind(this),remove:this.defaultRemove.bind(this),prepareFields:this.defaultPrepareFields.bind(this)},this.initialPromise=new Promise((function(resolve){_this.target.addEventListener("state:loaded",(function(event){resolve(event.detail.state)}))}))}return _createClass(StateManager,[{key:"setInitialState",value:function(initialState){if(void 0!==this.state)throw Error("Initial state can only be initialized ones");for(var state=new Proxy({},new Handler("state",this,!0)),_i=0,_Object$entries=Object.entries(initialState);_i<_Object$entries.length;_i++){var _Object$entries$_i=_slicedToArray(_Object$entries[_i],2),prop=_Object$entries$_i[0],propValue=_Object$entries$_i[1];state[prop]=propValue}this.state=state,this.readonly=!0,this.dispatchEvent({action:"state:loaded",state:this.state},this.target)}},{key:"getInitialPromise",value:function(){return this.initialPromise}},{key:"setReadOnly",value:function(readonly){this.readonly=readonly;var mode="off";this.readonly&&(mode="on",this._publishEvents()),this.dispatchEvent({action:"readmode:".concat(mode),state:this.state,element:null},this.target)}},{key:"addUpdateTypes",value:function(newFunctions){for(var _i2=0,_Object$entries2=Object.entries(newFunctions);_i2<_Object$entries2.length;_i2++){var _Object$entries2$_i=_slicedToArray(_Object$entries2[_i2],2),updateType=_Object$entries2$_i[0],updateFunction=_Object$entries2$_i[1];"function"==typeof updateFunction&&(this.updateTypes[updateType]=updateFunction.bind(newFunctions))}}},{key:"processUpdates",value:function(updates,updateTypes){var _this2=this;if(!Array.isArray(updates))throw Error("State updates must be an array");this.setReadOnly(!1),updates.forEach((function(update){if(void 0===update.name)throw Error("Missing state update name");_this2.processUpdate(update.name,update.action,update.fields,updateTypes)})),this.setReadOnly(!0)}},{key:"processUpdate",value:function(updateName,action,fields,updateTypes){var _action,_updateTypes$action,_updateTypes$prepareF;if(!fields)throw Error("Missing state update fields");void 0===updateTypes&&(updateTypes={});var method=null!==(_updateTypes$action=updateTypes[action=null!==(_action=action)&&void 0!==_action?_action:"update"])&&void 0!==_updateTypes$action?_updateTypes$action:this.updateTypes[action];if(void 0===method)throw Error("Unkown update action ".concat(action));method(this,updateName,(null!==(_updateTypes$prepareF=updateTypes.prepareFields)&&void 0!==_updateTypes$prepareF?_updateTypes$prepareF:this.updateTypes.prepareFields)(this,updateName,fields))}},{key:"defaultPrepareFields",value:function(stateManager,updateName,fields){return fields}},{key:"defaultCreate",value:function(stateManager,updateName,fields){var state=stateManager.state;state[updateName]instanceof StateMap?state[updateName].add(fields):state[updateName]=fields}},{key:"defaultDelete",value:function(stateManager,updateName,fields){if(!stateManager.get(updateName,fields.id))throw Error("Inexistent ".concat(updateName," ").concat(fields.id));var state=stateManager.state;state[updateName]instanceof StateMap?state[updateName].delete(fields.id):delete state[updateName]}},{key:"defaultRemove",value:function(stateManager,updateName,fields){if(stateManager.get(updateName,fields.id)){var state=stateManager.state;state[updateName]instanceof StateMap?state[updateName].delete(fields.id):delete state[updateName]}}},{key:"defaultUpdate",value:function(stateManager,updateName,fields){var current=stateManager.get(updateName,fields.id);if(!current)throw Error("Inexistent ".concat(updateName," ").concat(fields.id));for(var _i3=0,_Object$entries3=Object.entries(fields);_i3<_Object$entries3.length;_i3++){var _Object$entries3$_i=_slicedToArray(_Object$entries3[_i3],2),fieldName=_Object$entries3$_i[0],fieldValue=_Object$entries3$_i[1];current[fieldName]=fieldValue}}},{key:"defaultPut",value:function(stateManager,updateName,fields){var current=stateManager.get(updateName,fields.id);if(current)for(var _i4=0,_Object$entries4=Object.entries(fields);_i4<_Object$entries4.length;_i4++){var _Object$entries4$_i=_slicedToArray(_Object$entries4[_i4],2),fieldName=_Object$entries4$_i[0],fieldValue=_Object$entries4$_i[1];current[fieldName]=fieldValue}else{var state=stateManager.state;if(state[updateName]instanceof StateMap)return void state[updateName].add(fields);state[updateName]=fields}}},{key:"defaultOverride",value:function(stateManager,updateName,fields){var current=stateManager.get(updateName,fields.id);if(current){for(var _i5=0,_Object$entries5=Object.entries(current);_i5<_Object$entries5.length;_i5++){var fieldName=_slicedToArray(_Object$entries5[_i5],1)[0];void 0===fields[fieldName]&&delete current[fieldName]}for(var _i6=0,_Object$entries6=Object.entries(fields);_i6<_Object$entries6.length;_i6++){var _Object$entries6$_i=_slicedToArray(_Object$entries6[_i6],2),_fieldName=_Object$entries6$_i[0],fieldValue=_Object$entries6$_i[1];current[_fieldName]=fieldValue}}else{var state=stateManager.state;if(state[updateName]instanceof StateMap)return void state[updateName].add(fields);state[updateName]=fields}}},{key:"get",value:function(name,id){var state=this.state,current=state[name];if(current instanceof StateMap){if(void 0===id)throw Error("Missing id for ".concat(name," state update"));current=state[name].get(id)}return current}},{key:"registerStateAction",value:function(field,prop,action,data){var parentAction="updated";null!==prop?this.eventsToPublish.push({eventName:"".concat(field,".").concat(prop,":").concat(action),eventData:data,action:action}):parentAction=action,void 0!==data.id&&(null!==prop&&this.eventsToPublish.push({eventName:"".concat(field,"[").concat(data.id,"].").concat(prop,":").concat(action),eventData:data,action:action}),this.eventsToPublish.push({eventName:"".concat(field,"[").concat(data.id,"]:").concat(parentAction),eventData:data,action:parentAction})),this.eventsToPublish.push({eventName:"".concat(field,":").concat(parentAction),eventData:data,action:parentAction}),this.eventsToPublish.push({eventName:"state:updated",eventData:data,action:"updated"})}},{key:"_publishEvents",value:function(){var _this3=this,fieldChanges=this.eventsToPublish;this.eventsToPublish=[],this.dispatchEvent({action:"transaction:start",state:this.state,element:null,changes:fieldChanges},this.target),fieldChanges.sort((function(a,b){var _weights$a$action,_weights$b$action,weights={created:0,updated:1,deleted:2},aweight=null!==(_weights$a$action=weights[a.action])&&void 0!==_weights$a$action?_weights$a$action:0,bweight=null!==(_weights$b$action=weights[b.action])&&void 0!==_weights$b$action?_weights$b$action:0;return aweight===bweight?a.eventName.length-b.eventName.length:aweight-bweight}));var publishedEvents=new Set;fieldChanges.forEach((function(event){var _event$eventData$id,eventkey="".concat(event.eventName,".").concat(null!==(_event$eventData$id=event.eventData.id)&&void 0!==_event$eventData$id?_event$eventData$id:0);publishedEvents.has(eventkey)||(_this3.dispatchEvent({action:event.eventName,state:_this3.state,element:event.eventData},_this3.target),publishedEvents.add(eventkey))})),this.dispatchEvent({action:"transaction:end",state:this.state,element:null},this.target)}}]),StateManager}();_exports.default=StateManager;var Handler=function(){function Handler(name,stateManager,proxyValues){_classCallCheck(this,Handler),this.name=name,this.stateManager=stateManager,this.proxyValues=null!=proxyValues&&proxyValues}return _createClass(Handler,[{key:"set",value:function(obj,prop,value,receiver){if(this.stateManager.readonly)throw new Error("State locked. Use mutations to change ".concat(prop," value in ").concat(this.name,"."));if(JSON.stringify(obj[prop])===JSON.stringify(value))return!0;var action=void 0!==obj[prop]?"updated":"created";return this.proxyValues?Array.isArray(value)?obj[prop]=new StateMap(prop,this.stateManager).loadValues(value):obj[prop]=new Proxy(value,new Handler(prop,this.stateManager)):obj[prop]=value,void 0===this.stateManager.state||this.stateManager.registerStateAction(this.name,prop,action,receiver),!0}},{key:"deleteProperty",value:function(obj,prop){if(this.stateManager.readonly)throw new Error("State locked. Use mutations to delete ".concat(prop," in ").concat(this.name,"."));return prop in obj&&(delete obj[prop],this.stateManager.registerStateAction(this.name,prop,"deleted",obj)),!0}}]),Handler}(),StateMap=function(_Map){!function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&_setPrototypeOf(subClass,superClass)}(StateMap,_Map);var Derived,hasNativeReflectConstruct,_super=(Derived=StateMap,hasNativeReflectConstruct=_isNativeReflectConstruct(),function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)});function StateMap(name,stateManager,iterable){var _this4;return _classCallCheck(this,StateMap),(_this4=_super.call(this,iterable)).name=name,_this4.stateManager=stateManager,_this4}return _createClass(StateMap,[{key:"set",value:function(key,value){if(this.stateManager.readonly)throw new Error("State locked. Use mutations to change ".concat(key," value in ").concat(this.name,"."));if(key=this.normalizeKey(key),this.checkValue(value),null==key)throw Error("State lists keys cannot be null or undefined");if(this.normalizeKey(value.id)!==key)throw new Error("State error: ".concat(this.name," list element ID (").concat(value.id,") and key (").concat(key,") mismatch"));var action=_get(_getPrototypeOf(StateMap.prototype),"has",this).call(this,key)?"updated":"created",result=_get(_getPrototypeOf(StateMap.prototype),"set",this).call(this,key,new Proxy(value,new Handler(this.name,this.stateManager)));return void 0===this.stateManager.state||this.stateManager.registerStateAction(this.name,null,action,_get(_getPrototypeOf(StateMap.prototype),"get",this).call(this,key)),result}},{key:"checkValue",value:function(value){if("object"===!_typeof(value)&&null!==value)throw Error("State lists can contain objects only");if(void 0===value.id)throw Error("State lists elements must contain at least an id attribute")}},{key:"normalizeKey",value:function(key){return String(key).valueOf()}},{key:"add",value:function(value){return this.checkValue(value),this.set(value.id,value)}},{key:"get",value:function(key){return _get(_getPrototypeOf(StateMap.prototype),"get",this).call(this,this.normalizeKey(key))}},{key:"has",value:function(key){return _get(_getPrototypeOf(StateMap.prototype),"has",this).call(this,this.normalizeKey(key))}},{key:"delete",value:function(key){if(key=this.normalizeKey(key),this.stateManager.readonly)throw new Error("State locked. Use mutations to change ".concat(key," value in ").concat(this.name,"."));var previous=_get(_getPrototypeOf(StateMap.prototype),"get",this).call(this,key),result=_get(_getPrototypeOf(StateMap.prototype),"delete",this).call(this,key);return result?(this.stateManager.registerStateAction(this.name,null,"deleted",previous),result):result}},{key:"toJSON",value:function(){var result=[];return this.forEach((function(value){result.push(value)})),result}},{key:"loadValues",value:function(values){var _this5=this;return values.forEach((function(data){_this5.checkValue(data);var key=data.id,newvalue=new Proxy(data,new Handler(_this5.name,_this5.stateManager));_this5.set(key,newvalue)})),this}}]),StateMap}(_wrapNativeSuper(Map));return _exports.default}));

//# sourceMappingURL=statemanager.min.js.map