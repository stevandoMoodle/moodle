define("tiny_h5p/ui",["exports","editor_tiny/utils","./common","./options","core/normalise","core/templates","tiny_h5p/modal","core/modal_events","core/modal_factory"],(function(_exports,_utils,_common,_options,_normalise,_templates,_modal,_modal_events,_modal_factory){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.handleAction=void 0,_modal=_interopRequireDefault(_modal),_modal_events=_interopRequireDefault(_modal_events),_modal_factory=_interopRequireDefault(_modal_factory);var openingSelection=null;_exports.handleAction=function(editor){openingSelection=editor.selection.getBookmark(),displayDialogue(editor)};var _ref,_ref2,getTemplateContext=function(editor,data){var _permissions$upload,_permissions$embed,_data$url,permissions=(0,_options.getPermissions)(editor),canUpload=null!==(_permissions$upload=permissions.upload)&&void 0!==_permissions$upload&&_permissions$upload,canEmbed=null!==(_permissions$embed=permissions.embed)&&void 0!==_permissions$embed&&_permissions$embed,canUploadAndEmbed=canUpload&&canEmbed;return Object.assign({},{elementid:editor.id,canUpload:canUpload,canEmbed:canEmbed,canUploadAndEmbed:canUploadAndEmbed,showOptions:!1,fileURL:null!==(_data$url=null==data?void 0:data.url)&&void 0!==_data$url?_data$url:""},data)},getUrlFromSubmission=function(form,submittedUrl,permissions){if(!submittedUrl)return null;var url=new URL(submittedUrl);return null!=permissions&&permissions.upload&&form.querySelector('[name="download"]').checked&&url.searchParams.append("export",1),null!=permissions&&permissions.embed&&form.querySelector('[name="embed"]').checked&&url.searchParams.append("embed",1),form.querySelector('[name="copyright"]').checked&&url.searchParams.append("copyright",1),url},handleDialogueSubmission=(_ref=_asyncToGenerator(regeneratorRuntime.mark((function _callee(editor,modal,data){var form,submittedUrl,url,content;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(form=(0,_normalise.getList)(modal.getRoot())[0].querySelector("form")){_context.next=4;break}return displayDialogue(editor,Object.assign({},data)),_context.abrupt("return");case 4:if(submittedUrl=form.querySelector('input[name="url"]').value,url=getUrlFromSubmission(form,submittedUrl,(0,_options.getPermissions)(editor))){_context.next=9;break}return displayDialogue(editor,Object.assign({},data,{url:submittedUrl,invalidUrl:!0})),_context.abrupt("return");case 9:return _context.next=11,(0,_templates.renderForPromise)("".concat(_common.component,"/content"),{url:url.toString()});case 11:content=_context.sent,editor.selection.moveToBookmark(openingSelection),editor.execCommand("mceInsertContent",!1,content.html),editor.selection.moveToBookmark(openingSelection);case 15:case"end":return _context.stop()}}),_callee)}))),function(_x,_x2,_x3){return _ref.apply(this,arguments)}),getCurrentH5PData=function(currentH5P){var url,data={};try{url=new URL(currentH5P.textContent)}catch(error){return data}return url.searchParams.has("export")&&(data.download=!0,data.showOptions=!0,url.searchParams.delete("export")),url.searchParams.has("embed")&&(data.embed=!0,data.showOptions=!0,url.searchParams.delete("embed")),url.searchParams.has("copyright")&&(data.copyright=!0,data.showOptions=!0,url.searchParams.delete("copyright")),data.url=url.toString(),data},displayDialogue=(_ref2=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(editor){var data,selection,currentH5P,modal,$root,root,_args2=arguments;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return data=_args2.length>1&&void 0!==_args2[1]?_args2[1]:{},selection=editor.selection.getNode(),(currentH5P=selection.closest(".h5p-placeholder"))&&Object.assign(data,getCurrentH5PData(currentH5P)),_context2.next=6,_modal_factory.default.create({type:_modal.default.TYPE,templateContext:getTemplateContext(editor,data),large:!0});case 6:(modal=_context2.sent).show(),$root=modal.getRoot(),root=$root[0],$root.on(_modal_events.default.save,(function(event,modal){handleDialogueSubmission(editor,modal,data)})),root.addEventListener("click",(function(e){e.target.closest('[data-target="filepicker"]')&&(0,_utils.displayFilepicker)(editor,"h5p").then((function(params){return""!==params.url&&(root.querySelector('form input[name="url"]').value=params.url),params})).catch()}));case 12:case"end":return _context2.stop()}}),_callee2)}))),function(_x4){return _ref2.apply(this,arguments)})}));

//# sourceMappingURL=ui.min.js.map