function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("tiny_recordrtc/recording/commonmodule",["exports","core/str","../common","./abstractmodule"],(function(_exports,_str,_common,AbstractModule){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _slicedToArray(arr,i){return function(arr){if(Array.isArray(arr))return arr}(arr)||function(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.uploadToServer=_exports.uploadHandler=_exports.stopRecording=_exports.startRecording=_exports.setTime=_exports.selectRecOptions=_exports.pad=_exports.makeXmlhttprequest=_exports.insertAnnotation=_exports.handleStop=_exports.handleDataAvailable=_exports.data=_exports.createAnnotation=_exports.captureUserMedia=void 0,AbstractModule=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(AbstractModule);var data={editorScope:null,alertWarning:null,alertDanger:null,player:null,playerDOM:null,startStopBtn:null,uploadBtn:null,countdownSeconds:null,countdownTicker:null,recType:null,stream:null,mediaRecorder:null,chunks:null,blobSize:null,maxUploadSize:null,audioData:null,modal:null};_exports.data=data;_exports.captureUserMedia=function(mediaConstraints,successCallback,errorCallback){navigator.mediaDevices.getUserMedia(mediaConstraints).then(successCallback).catch(errorCallback)};var handleDataAvailable=function(event){data.chunks.push(event.data),data.blobSize+=event.data.size,data.blobSize>=data.maxUploadSize&&(localStorage.getItem("alerted")?localStorage.removeItem("alerted"):(localStorage.setItem("alerted","true"),data.startStopBtn.click(),AbstractModule.showAlert("nearingmaxsize")),data.chunks.pop())};_exports.handleDataAvailable=handleDataAvailable;var _ref,handleStop=(_ref=_asyncToGenerator(regeneratorRuntime.mark((function _callee(){var _yield$Promise$all,_yield$Promise$all2,attachrecording,blob;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.next=2,Promise.all([(0,_str.get_string)("attachrecording",_common.component)]);case 2:_yield$Promise$all=_context.sent,_yield$Promise$all2=_slicedToArray(_yield$Promise$all,1),attachrecording=_yield$Promise$all2[0],blob=new Blob(data.chunks,{type:data.mediaRecorder.mimeType}),data.player.srcObject=null,data.player.src=URL.createObjectURL(blob),data.player.muted=!1,data.player.controls=!0,data.player.parentElement.parentElement.classList.remove("hide"),data.uploadBtn.parentElement.parentElement.classList.remove("hide"),data.uploadBtn.textContent=attachrecording,data.uploadBtn.disabled=!1,data.uploadBtn.addEventListener("click",uploadHandler);case 15:case"end":return _context.stop()}}),_callee)}))),function(){return _ref.apply(this,arguments)});_exports.handleStop=handleStop;var _ref2,uploadHandler=(_ref2=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(){var _yield$Promise$all3,_yield$Promise$all4,uploadfailed,uploadfailed404,uploadaborted;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return _context2.next=2,Promise.all([(0,_str.get_string)("uploadfailed",_common.component),(0,_str.get_string)("uploadfailed404",_common.component),(0,_str.get_string)("uploadaborted",_common.component)]);case 2:_yield$Promise$all3=_context2.sent,_yield$Promise$all4=_slicedToArray(_yield$Promise$all3,3),uploadfailed=_yield$Promise$all4[0],uploadfailed404=_yield$Promise$all4[1],uploadaborted=_yield$Promise$all4[2],0===data.chunks.length?AbstractModule.showAlert("norecordingfound"):(data.uploadBtn.disabled=!0,uploadToServer(data.recType,(function(progress,fileURLOrError){"ended"===progress?(data.uploadBtn.disabled=!1,insertAnnotation(data.recType,fileURLOrError)):"upload-failed"===progress?(data.uploadBtn.disabled=!1,data.uploadBtn.textContent="".concat(uploadfailed," ").concat(fileURLOrError)):"upload-failed-404"===progress?(data.uploadBtn.disabled=!1,data.uploadBtn.textContent=uploadfailed404):"upload-aborted"===progress?(data.uploadBtn.disabled=!1,data.uploadBtn.textContent="".concat(uploadaborted," ").concat(fileURLOrError)):data.uploadBtn.textContent=progress})));case 8:case"end":return _context2.stop()}}),_callee2)}))),function(){return _ref2.apply(this,arguments)});_exports.uploadHandler=uploadHandler;var _ref3,startRecording=(_ref3=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(type,stream){var _yield$Promise$all5,_yield$Promise$all6,stoprecording,options,timerText;return regeneratorRuntime.wrap((function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:return _context3.next=2,Promise.all([(0,_str.get_string)("stoprecording",_common.component)]);case 2:_yield$Promise$all5=_context3.sent,_yield$Promise$all6=_slicedToArray(_yield$Promise$all5,1),stoprecording=_yield$Promise$all6[0],options=selectRecOptions(type),data.mediaRecorder=new MediaRecorder(stream,options),data.mediaRecorder.ondataavailable=handleDataAvailable,data.mediaRecorder.onstop=handleStop,data.mediaRecorder.start(1e3),data.player.muted=!0,data.countdownSeconds="audio"===type?data.editorScope.audiotimelimit:"video"===type?data.editorScope.videotimelimit:data.editorScope.defaulttimelimit,data.countdownSeconds++,timerText=stoprecording,timerText+=' (<span id="minutes"></span>:<span id="seconds"></span>)',data.startStopBtn.innerHTML=timerText,setTime(),data.countdownTicker=setInterval(setTime,1e3),data.startStopBtn.disabled=!1;case 19:case"end":return _context3.stop()}}),_callee3)}))),function(_x,_x2){return _ref3.apply(this,arguments)});_exports.startRecording=startRecording;var selectRecOptions=function(recType){var types,options;"audio"===recType?(types=["audio/webm;codecs=opus","audio/ogg;codecs=opus"],options={audioBitsPerSecond:parseInt(data.editorScope.audiobitrate)}):(types=["video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/webm;codecs=vp8,opus"],options={audioBitsPerSecond:parseInt(data.editorScope.audiobitrate),videoBitsPerSecond:parseInt(data.editorScope.videobitrate)});var compatTypes=types.filter((function(type){return MediaRecorder.isTypeSupported(type)}));return 0!==compatTypes.length&&(options.mimeType=compatTypes[0]),options};_exports.selectRecOptions=selectRecOptions;var uploadToServer=function(type,callback){var xhr=new XMLHttpRequest;xhr.open("GET",data.player.src,!0),xhr.responseType="blob",xhr.addEventListener("load",(function(){if(200===xhr.status){var blob=xhr.response,fileName=(1e3*Math.random()).toString().replace(".","");fileName+="audio"===type?"-audio.ogg":"-video.webm";var formData=new FormData,filepickerOptions=data.editorScope.filepickeroptions.link,repositoryKeys=Object.keys(filepickerOptions.repositories);formData.append("repo_upload_file",blob,fileName),formData.append("itemid",filepickerOptions.itemid);for(var i=0;i<repositoryKeys.length;i++)if("upload"===filepickerOptions.repositories[repositoryKeys[i]].type){formData.append("repo_id",filepickerOptions.repositories[repositoryKeys[i]].id);break}formData.append("env",filepickerOptions.env),formData.append("sesskey",M.cfg.sesskey),formData.append("client_id",filepickerOptions.client_id),formData.append("savepath","/"),formData.append("ctx_id",filepickerOptions.context.id);var uploadEndpoint="".concat(M.cfg.wwwroot,"/repository/repository_ajax.php?action=upload");makeXmlhttprequest(uploadEndpoint,formData,(function(progress,responseText){"upload-ended"===progress?callback("ended",JSON.parse(responseText).url):callback(progress)}))}})),xhr.send()};_exports.uploadToServer=uploadToServer;var _ref4,makeXmlhttprequest=(_ref4=_asyncToGenerator(regeneratorRuntime.mark((function _callee4(url,data,callback){var _yield$Promise$all7,_yield$Promise$all8,uploadprogress,xhr;return regeneratorRuntime.wrap((function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:return _context4.next=2,Promise.all([(0,_str.get_string)("uploadprogress",_common.component)]);case 2:_yield$Promise$all7=_context4.sent,_yield$Promise$all8=_slicedToArray(_yield$Promise$all7,1),uploadprogress=_yield$Promise$all8[0],(xhr=new window.XMLHttpRequest).onreadystatechange=function(){4===xhr.readyState&&200===xhr.status?callback("upload-ended",xhr.responseText):404===xhr.status&&callback("upload-failed-404")},xhr.upload.addEventListener("progress",(function(e){callback("".concat(Math.round(e.loaded/e.total*100),"% ").concat(uploadprogress))})),xhr.upload.addEventListener("error",(function(error){callback("upload-failed",error)})),xhr.upload.addEventListener("abort",(function(error){callback("upload-aborted",error)})),xhr.open("POST",url,!0),xhr.send(data);case 12:case"end":return _context4.stop()}}),_callee4)}))),function(_x3,_x4,_x5){return _ref4.apply(this,arguments)});_exports.makeXmlhttprequest=makeXmlhttprequest;_exports.stopRecording=function(stream){data.mediaRecorder.stop();for(var tracks=stream.getTracks(),i=0;i<tracks.length;i++)tracks[i].stop()};var pad=function(val){var valString=val+"";return valString.length<2?"0"+valString:valString};_exports.pad=pad;var setTime=function(){data.countdownSeconds--,document.querySelector("span#seconds").textContent=pad(data.countdownSeconds%60),document.querySelector("span#minutes").textContent=pad(parseInt(data.countdownSeconds/60,10)),0===data.countdownSeconds&&data.startStopBtn.click()};_exports.setTime=setTime;var createAnnotation=function(type,recordingurl){var html="";return html="audio"==type?"<audio controls='true'>":"<video controls='true'>",html+="<source src='".concat(recordingurl,"'>").concat(recordingurl),html+="audio"==type?"</audio>":"</video>"};_exports.createAnnotation=createAnnotation;var _ref5,insertAnnotation=(_ref5=_asyncToGenerator(regeneratorRuntime.mark((function _callee5(type,recordingurl){var _yield$Promise$all9,_yield$Promise$all10,attachrecording,annotation;return regeneratorRuntime.wrap((function(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:return _context5.next=2,Promise.all([(0,_str.get_string)("attachrecording",_common.component)]);case 2:_yield$Promise$all9=_context5.sent,_yield$Promise$all10=_slicedToArray(_yield$Promise$all9,1),attachrecording=_yield$Promise$all10[0],(annotation=createAnnotation(type,recordingurl))?(data.audioData=annotation,data.editorScope.editor.insertContent(annotation),data.editorScope.currentModal.destroy()):data.uploadBtn.textContent=attachrecording;case 7:case"end":return _context5.stop()}}),_callee5)}))),function(_x6,_x7){return _ref5.apply(this,arguments)});_exports.insertAnnotation=insertAnnotation}));

//# sourceMappingURL=commonmodule.min.js.map