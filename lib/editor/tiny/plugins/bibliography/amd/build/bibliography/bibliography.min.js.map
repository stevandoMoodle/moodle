{"version":3,"file":"bibliography.min.js","sources":["../../src/bibliography/bibliography.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @package    tiny_bibliography\n * @copyright  2023 Stevani Andolo <stevani@hotmail.com.au>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Modal from 'core/modal_factory';\nimport * as ModalEvents from 'core/modal_events';\nimport {get_string as getString} from 'core/str';\n\nimport {component} from '../common';\nimport Setter from './setter';\nimport {getExample} from './example';\nimport {getDialogueContent, getBioListWithButtons} from './template_loader';\nimport {byId, getSourceLangString, resetBibliographyFormFields, showElement, ucFirst} from './helper';\n\nexport default class Bibliography extends Setter {\n\n    constructor(editor) {\n        super();\n        this.editor = editor;\n        this.modal = null;\n\n        this.allData = {};\n        this.selectedSource = null;\n        this.selectedStyle = null;\n        this.fields = [];\n\n        this.create = true;\n        this.updateId = null;\n        this.updateIndex = null;\n\n        this.attachedClickEventListener = [];\n        this.attachedChangeEventListener = [];\n        this.attachedKeyupEventListener = [];\n        this.initSetter();\n    }\n\n    destroy() {\n        delete this.editor;\n        this.modal.destroy();\n        delete this.modal;\n    }\n\n    async displayDialogue() {\n        const sources = await getSourceLangString(this.selectedStyle.ALL_SOURCES);\n        this.modal = await Modal.create({\n            type: Modal.types.DEFAULT,\n            large: true,\n            title: getString('pluginname', component),\n            body: getDialogueContent(sources)\n        });\n\n        // Destroy the class when hiding the modal.\n        this.modal.getRoot().on(ModalEvents.hidden, () => this.destroy());\n\n        this.modal.getRoot().on(ModalEvents.bodyRendered, async() => {\n            // Generates bibliography list and display in modal.\n            this.generateBioAndDisplayInModal();\n\n            // Manually get the bio example.\n            getExample();\n\n            await this.setSource();\n        });\n\n        this.modal.show();\n    }\n\n    resetBibliographyContainerHeight = () => {\n        const form = byId('bibliography-info-holder');\n        const bibliographyContainer = byId('bibliography-info-list-holder');\n        bibliographyContainer.style.height = `0px`;\n        if (bibliographyContainer) {\n            bibliographyContainer.style.height = `${form.offsetHeight - 15}px`;\n            showElement(['bibliography-info-list-holder']);\n        }\n    };\n\n    addKeyupListeners = () => {\n        const element = this.modal.getRoot()[0];\n        const handler = this.createKeyupListenerHandler.bind(null);\n        element.addEventListener('keyup', handler);\n        this.attachedKeyupEventListener.push([element, handler, 'keyup']);\n    };\n\n    createKeyupListenerHandler = (event) => {\n        const exampleNodes = event.target.closest('[data-type=\"bibliography-info-example\"]');\n        if (exampleNodes) {\n            this.allData[exampleNodes.dataset.name] = exampleNodes.value;\n            if (exampleNodes.dataset.author === 'true') {\n                this.splitAuthorName(exampleNodes.dataset.name);\n            }\n        }\n    };\n\n    removeAttachedKeyupListeners = () => {\n        this.attachedKeyupEventListener.forEach(listener => {\n            // Destruct the listener.\n            const [element, handler, even] = listener;\n\n            // Remove the attached listener.\n            element.removeEventListener(even, handler);\n        });\n        this.attachedKeyupEventListener = [];\n    };\n\n    addChangeListeners = () => {\n        const element = this.modal.getRoot()[0];\n        const handler = this.createChangeListenerHandler.bind(null);\n        element.addEventListener('change', handler);\n        this.attachedChangeEventListener.push([element, handler, 'change']);\n    };\n\n    createChangeListenerHandler = (event) => {\n        const exampleNodes = event.target.closest('[data-type=\"style-source\"]');\n        if (exampleNodes) {\n            const callback = `set${ucFirst(exampleNodes.dataset.name)}`;\n            this[callback](exampleNodes.value);\n        }\n    };\n\n    removeAttachedChangeListeners = () => {\n        this.attachedChangeEventListener.forEach(listener => {\n            // Destruct the listener.\n            const [element, handler, even] = listener;\n\n            // Remove the attached listener.\n            element.removeEventListener(even, handler);\n        });\n        this.attachedChangeEventListener = [];\n    };\n\n    addClickListeners = () => {\n        const element = this.modal.getRoot()[0];\n        const handler = this.createClickListenerHandler.bind(null);\n        element.addEventListener('click', handler);\n        this.attachedClickEventListener.push([element, handler, 'click']);\n    };\n\n    createClickListenerHandler = (event) => {\n        const eventTarget = event.target;\n\n        // Sets and generates custom authors' names.\n        this.setCustomAuthorNames(event);\n\n        // Generates a new bibliography list and inserts it.\n        const generateList = eventTarget.closest('[data-action=\"generate-list\"]');\n        if (generateList) {\n            this.selectedStyle.generateBibliography(this);\n        }\n\n        // Generates and inserts a new citation.\n        const optionalFields = eventTarget.closest('[data-action=\"show-other-fields\"]');\n        if (optionalFields) {\n            this.allData.showOtherFields = optionalFields.checked;\n            this.loadFieldTemplate(this.allData.source);\n        }\n\n        // Generates and inserts a new citation.\n        const cite = eventTarget.closest('[data-action=\"cite-this\"]');\n        if (cite) {\n            this.selectedStyle.citeThis(this, event);\n        }\n\n        // Delete citation.\n        const deleteBio = eventTarget.closest('[data-action=\"delete-bio\"]');\n        if (deleteBio) {\n            this.selectedStyle.deleteBibliography({...this, deleteBio: deleteBio});\n        }\n\n        // Edit bibliography.\n        const editBio = eventTarget.closest('[data-action=\"edit-bio\"]');\n        if (editBio) {\n            this.selectedStyle.editBibliography(this, editBio);\n        }\n\n        // Edit bibliography.\n        const saveForm = eventTarget.closest('[data-action=\"reset-form\"]');\n        if (saveForm) {\n            this.create = true;\n            this.updateId = null;\n            this.updateIndex = null;\n            resetBibliographyFormFields(this, false);\n\n            saveForm.remove();\n        }\n    };\n\n    removeAttachedClickListeners = () => {\n        this.attachedClickEventListener.forEach(listener => {\n            // Destruct the listener.\n            const [element, handler, even] = listener;\n\n            // Remove the attached listener.\n            element.removeEventListener(even, handler);\n        });\n        this.attachedClickEventListener = [];\n    };\n\n    /**\n     * Generates bibliography list and display them in the modal.\n     */\n    generateBioAndDisplayInModal = () => {\n        let bioList = this.editor.dom.select('[id=\"id-bibliography-holder\"]');\n        if (bioList.length > 0) {\n            let nodes = byId('bibliography-info-list-holder'),\n            index = 1;\n            nodes.innerHTML = '';\n            bioList[0].childNodes.forEach(async node => {\n\n                let newNode;\n                if (node.nodeName === 'P' && node.textContent.trim() !== '') {\n                    newNode = await getBioListWithButtons({\n                        id: node.getAttribute('class'),\n                        last: (index === bioList[0].childNodes.length - 1) ? true : false,\n                        index: index++,\n                        bio: node.querySelectorAll('.d-flex')[0].innerHTML.trim(),\n                        heading: false\n                    });\n                } else if (node.nodeName === 'H3' && node.textContent.trim() !== '') {\n                    newNode = await getBioListWithButtons({\n                        id: node.getAttribute('class'),\n                        bio: node.innerHTML.trim(),\n                        heading: true\n                    });\n                }\n\n                if (newNode) {\n                    nodes.innerHTML += newNode;\n                }\n            });\n        }\n    };\n}\n"],"names":["Bibliography","Setter","constructor","editor","form","bibliographyContainer","style","height","offsetHeight","element","this","modal","getRoot","handler","createKeyupListenerHandler","bind","addEventListener","attachedKeyupEventListener","push","event","exampleNodes","target","closest","allData","dataset","name","value","author","splitAuthorName","forEach","listener","even","removeEventListener","createChangeListenerHandler","attachedChangeEventListener","createClickListenerHandler","attachedClickEventListener","eventTarget","setCustomAuthorNames","selectedStyle","generateBibliography","optionalFields","showOtherFields","checked","loadFieldTemplate","source","citeThis","deleteBio","deleteBibliography","editBio","editBibliography","saveForm","create","updateId","updateIndex","remove","bioList","dom","select","length","nodes","index","innerHTML","childNodes","async","newNode","node","nodeName","textContent","trim","id","getAttribute","last","bio","querySelectorAll","heading","selectedSource","fields","initSetter","destroy","sources","ALL_SOURCES","Modal","type","types","DEFAULT","large","title","component","body","on","ModalEvents","hidden","bodyRendered","generateBioAndDisplayInModal","setSource","show"],"mappings":"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"}