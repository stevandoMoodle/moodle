{"version":3,"file":"ieee.min.js","sources":["../../../src/bibliography/styles/ieee.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @package    tiny_bibliography\n * @copyright  2023 Stevani Andolo <stevani@hotmail.com.au>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport {get_string as getString} from 'core/str';\nimport {alert} from 'core/notification';\nimport {byId, getInTextRefNumber, resetBibliographyFormFields, toWords, ucFirst, wordsFormat} from './../helper';\nimport {firstItem, getBioContent} from './../templateloader';\nimport Base from '../base';\nimport {component} from '../../common';\nimport Book from '../handlers/book';\nimport Website from '../handlers/website';\nimport BookWithChapterTitle from '../handlers/book_with_chapter_title';\n\nexport default class Ieee extends Base {\n    constructor() {\n        super();\n        this.DEFAULT = {\n            SOURCE: 'book'\n        };\n\n        this.ALL_SOURCES = [\n            'source:book',\n            'source:website',\n            'source:book_with_chapter_title'\n        ];\n    }\n\n    /**\n     * Sets selected source.\n     *\n     * @param {String} data\n     */\n    setSelectedSource = async(data = null) => {\n        let selectedSource;\n        if (!data) {\n            data = this.DEFAULT.SOURCE;\n        }\n\n        switch (data) {\n            case 'book':\n                selectedSource = new Book();\n                break;\n            case 'website':\n                selectedSource = new Website();\n                break;\n            case 'book_with_chapter_title':\n                selectedSource = new BookWithChapterTitle();\n                break;\n            default:\n                // Set to default resource\n                selectedSource = new Book();\n\n                // Set the selected option to default source\n                byId('id_bibliography_source').value = this.DEFAULT.SOURCE;\n\n                // Alert the user.\n                alert(\n                    await getString('alert:warning', component),\n                    await getString('sourcenotavailable', component, toWords('_', data))\n                );\n        }\n        return selectedSource;\n    };\n\n    /**\n     * Delete a citation.\n     *\n     * @param {object} bio\n     * @param {event} event\n     */\n    deleteBibliography = (bio, event) => {\n        const deleteBio = event.target.closest('[data-action=\"delete-bio\"]');\n        if (deleteBio) {\n            const list = bio.editor.dom.select(`[class=\"${deleteBio.dataset.id}\"]`);\n            const index = parseInt(deleteBio.dataset.index);\n            if (list) {\n                const refNo = bio.editor.dom.select(`[class=\"cited-bibliography\"]`);\n                refNo.forEach(ref => {\n                    const text = getInTextRefNumber(ref);\n                    if (parseInt(text) === index) {\n                        // Delete citation(s) if data-index is the same as current text of it.\n                        ref.remove();\n                    }\n                });\n\n                // Reorder citations.\n                this.reorderCitation(bio.editor, index, false);\n\n                // Delete found bibliography list.\n                list[0].remove();\n\n                // Reorder the bibliography list.\n                this.reorderBibliography(bio.editor);\n\n                // Close the modal.\n                bio.modal.hide();\n            }\n        }\n    };\n\n    /**\n     * Reorder bibliography list.\n     *\n     * @param {object} editor\n     */\n    reorderBibliography = (editor) => {\n        let bioList = editor.dom.select('[class=\"id-bibliography-holder\"]');\n\n        // Check if child nodes of bioList is equal to 1, delete the whole bibliography div.\n        if (bioList[0].childNodes.length === 1) {\n            bioList[0].remove();\n        }\n\n        if (bioList.length > 0) {\n            let index = 0;\n            bioList[0].childNodes.forEach(node => {\n                if (node.nodeName === 'P' && node.textContent.trim() !== '') {\n                    // Reset all info to pure text.\n                    node.childNodes[2].removeAttribute('class');\n                    node.childNodes[2].classList.add(`id-refno-${index}`);\n                    node.childNodes[2].textContent = `[${index}]`;\n\n                    node.removeAttribute('class');\n                    node.classList.add(`id-bibliography-list-${index}`);\n                }\n                index++;\n            });\n        }\n    };\n\n    /**\n     * Reorder all citations.\n     *\n     * @param {object} editor\n     * @param {number} refNumber\n     * @param {boolean} increase\n     */\n    reorderCitation = (editor, refNumber, increase = false) => {\n        const refList = editor.dom.select('[class=\"cited-bibliography\"]');\n        if (refList.length > 0) {\n            refList.forEach(ref => {\n                const content = parseInt(getInTextRefNumber(ref));\n                if (content >= refNumber) {\n                    ref.textContent = `[${content - 1}]`;\n                    if (increase) {\n                        ref.textContent = `[${content + 1}]`;\n                    }\n                }\n            });\n        }\n    };\n\n    /**\n     * Generates author's name based on the style.\n     *\n     * @param {string} firstName\n     * @param {string} middleName\n     * @param {string} sureName\n     * @returns {object|null}\n     */\n    generateAuthorName(firstName = null, middleName = null, sureName = null) {\n        if (firstName !== null) {\n            const genSureName = sureName ? (ucFirst(sureName)) : ''; // Generated sure name.\n            sureName = sureName ? sureName + ', ' : null;\n\n            let genMiddleName = ''; // Generated middle name.\n            let genFirstName = ''; // Generated first name.\n            if (sureName) {\n                genMiddleName = middleName ? ucFirst(middleName, false) + '. ' : '';\n                middleName = middleName ? middleName + '' : null;\n            } else {\n                genMiddleName = middleName ? ucFirst(middleName, false) : '';\n                middleName = middleName ? middleName : null;\n            }\n\n            if (sureName || middleName) {\n                genFirstName = firstName ? ucFirst(firstName, false) + '. ' : '';\n                firstName = firstName ? firstName + ' ' : '';\n            } else {\n                genFirstName = firstName ? ucFirst(firstName, false) : '';\n                firstName = firstName ? firstName : '';\n            }\n\n            return {\n                \"generated\": genFirstName + genMiddleName + genSureName, // Generated names.\n                \"originated\": (sureName ?? ', ') + firstName + (middleName ?? '') // Pure names.\n            };\n        }\n        return null;\n    }\n\n    /**\n     * Generates or updates the bibliography.\n     *\n     * @param {object} bio\n     */\n    generateBibliography = async(bio) => {\n        if (this.checkRequiredFields(bio)) {\n            if (bio.create) {\n                let bioList = bio.editor.dom.select('[class=\"id-bibliography-holder\"]'),\n                index = bioList.length;\n                if (index > 0) {\n                    index = bioList[0].querySelectorAll('div').length;\n                }\n\n                bio.updateIndex = index + 1;\n                bio.allData.author = wordsFormat(bio.allData.author);\n\n                let info = await getBioContent(bio);\n                if (index === 0) {\n                    info = await firstItem({reference: info, referenceNumber: bio.updateIndex});\n                }\n\n                let bibliography;\n                if (index > 0) {\n                    bibliography = info;\n                } else {\n                    bibliography = await Templates.render('tiny_bibliography/bibliography_header', {\n                        info: info\n                    });\n                }\n\n                if (index === 0) {\n                    bio.editor.dom.add(\n                        bio.editor.getBody(),\n                        'div',\n                        {'id': 'bibliography-container'},\n                        bibliography\n                    );\n                    bio.editor.dom.select('[id=\"bibliography-container\"]')[0].scrollIntoView({\n                        behavior: 'smooth',\n                        block: 'nearest'\n                    });\n                } else {\n                    bio.editor.dom.add(\n                        bioList[0],\n                        'div',\n                        {'id': `id-bibliography-list-${bio.updateIndex}`},\n                        bibliography\n                    );\n\n                    // const currentElement = bio.editor.selection.getNode().getAttribute('class');\n                    // if (currentElement && currentElement.includes('id-bibliography-list-')) {\n                    //     // Put the cursor to the end of the selected bio element.\n                    //     textNodes = getTextNodes(bio.editor.selection.getNode());\n                    // }\n\n                    // // Locate to insert a new bio.\n                    // bio.editor.selection.setCursorLocation(\n                    //     textNodes[textNodes.length - 1],\n                    //     textNodes[textNodes.length - 1].textContent.length\n                    // );\n\n                    // // Insert new bio list.\n                    // await bio.editor.insertContent(bibliography);\n\n                    // // Check if cursor is currently located within the bio list element.\n                    // if (currentElement && currentElement.includes('id-bibliography-list-')) {\n                    //     // Reorder citations.\n                    //     let refNo = currentElement.split('-');\n                    //     refNo = parseInt(refNo[refNo.length - 1]) + 1;\n\n                    //     // Reorder all citations.\n                    //     this.reorderCitation(bio.editor, refNo, true);\n\n                    //     // Reorder bibliography list.\n                    //     this.reorderBibliography(bio.editor);\n                    // }\n                }\n            } else {\n                const targetList = bio.editor.dom.select(`[class=\"${bio.updateId}\"]`)[0];\n                targetList.innerHTML = await getBioContent(bio);\n                bio.create = true;\n            }\n\n            resetBibliographyFormFields(bio);\n            bio.generateBioAndDisplayInModal();\n        } else {\n            alert(\n                await getString('alert:error', component),\n                await getString('fieldsrequired', component)\n            );\n        }\n    };\n}\n"],"names":["Ieee","Base","constructor","async","selectedSource","data","_this","DEFAULT","SOURCE","Book","Website","BookWithChapterTitle","value","component","bio","event","deleteBio","target","closest","list","editor","dom","select","dataset","id","index","parseInt","forEach","ref","text","remove","reorderCitation","reorderBibliography","modal","hide","bioList","childNodes","length","node","nodeName","textContent","trim","removeAttribute","classList","add","refNumber","increase","refList","content","this","checkRequiredFields","create","querySelectorAll","updateIndex","allData","author","bibliography","info","reference","referenceNumber","Templates","render","getBody","scrollIntoView","behavior","block","updateId","innerHTML","generateBioAndDisplayInModal","ALL_SOURCES","generateAuthorName","firstName","middleName","sureName","genSureName","genMiddleName","genFirstName"],"mappings":"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"}