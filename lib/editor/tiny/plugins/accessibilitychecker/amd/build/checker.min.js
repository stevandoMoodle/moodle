define("tiny_accessibilitychecker/checker",["exports","core/templates","core/str","core/notification","./common","core/modal_factory","core/modal_events","./colorbase"],(function(_exports,_templates,_str,_notification,_common,Modal,ModalEvents,_colorbase){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.Checker=void 0,_templates=(obj=_templates)&&obj.__esModule?obj:{default:obj},Modal=_interopRequireWildcard(Modal),ModalEvents=_interopRequireWildcard(ModalEvents);_exports.Checker=class{constructor(editor){_defineProperty(this,"displayDialogue",(async()=>{await this.setSelectedNode(),Modal.create({type:Modal.types.DEFAULT,large:!0,title:(0,_str.get_string)("pluginname",_common.component),body:this.getDialogueContent()}).then((modal=>(this.modal=modal,modal.getRoot().on(ModalEvents.hidden,(()=>{(!this.selectedNode||this.selectedNode&&!["TD","TABLE"].includes(this.selectedNode.nodeName))&&(this.selectedNode&&this.selectAndScroll(this.selectedNode),this.editor.dom.select("body")[0].focus()),modal.destroy(),this.selectedNode=null})),modal.show(),modal))).catch()})),_defineProperty(this,"setSelectedNode",(async()=>{var _this$selectedNode,_this$selectedNode2,_this$selectedNode3,_this$selectedNode4,_this$selectedNode5;const selectedNode=this.editor.selection.getNode();if("BODY"!==selectedNode.nodeName&&(this.selectedNode=selectedNode),("P"===(null===(_this$selectedNode=this.selectedNode)||void 0===_this$selectedNode?void 0:_this$selectedNode.nodeName)&&""===(null===(_this$selectedNode2=this.selectedNode)||void 0===_this$selectedNode2?void 0:_this$selectedNode2.textContent)||"BR"===(null===(_this$selectedNode3=this.selectedNode)||void 0===_this$selectedNode3?void 0:_this$selectedNode3.nodeName)||"BR"===(null===(_this$selectedNode4=this.selectedNode)||void 0===_this$selectedNode4?void 0:_this$selectedNode4.nodeName)&&null!==(_this$selectedNode5=this.selectedNode)&&void 0!==_this$selectedNode5&&_this$selectedNode5.hasAttribute("data-mce-bogus"))&&(this.selectedNode=null),this.selectedNode){const checkAll=await this.checkConfirmation();this.selectedNode=checkAll?null:this.selectedNode}})),_defineProperty(this,"checkConfirmation",(async()=>{try{return await(0,_notification.saveCancelPromise)(await(0,_str.get_string)("check_title",_common.component),await(0,_str.get_string)("check_desc",_common.component),await(0,_str.get_string)("confirm_yes",_common.component)),!0}catch{return!1}})),_defineProperty(this,"getDialogueContent",(async()=>{const content=await _templates.default.render("tiny_accessibilitychecker/warning_content",{warning:await this.getWarnings()}),parsedHtml=this.parseHtml(content);return this.setSelection(parsedHtml),parsedHtml})),_defineProperty(this,"parseHtml",(html=>(new DOMParser).parseFromString(html,"text/html").body.firstElementChild)),_defineProperty(this,"setSelection",(content=>{content.querySelectorAll("a").forEach((anchor=>{anchor.addEventListener("click",(e=>{e.preventDefault();const node=e.currentTarget.getAttribute("sourceNode");let nodeId=e.currentTarget.getAttribute("nodeId");nodeId="null"===nodeId?0:nodeId,node&&(node.includes(",")||"body"===node?this.selectAndScroll(this.editor.dom.select("body")[0]):this.selectAndScroll(this.editor.dom.select(node)[nodeId])),this.closeModal()}))}))})),_defineProperty(this,"selectAndScroll",(node=>{this.selectedNode=node,this.editor.selection.select(node).scrollIntoView({behavior:"smooth",block:"nearest"})})),_defineProperty(this,"closeModal",(()=>{this.modal.destroy()})),_defineProperty(this,"getWarnings",(async()=>{let list="",selectedNodeName=this.selectedNode?this.selectedNode.nodeName.toLowerCase():null;if(selectedNodeName="td"===selectedNodeName?"table":selectedNodeName,null===selectedNodeName||"img"===selectedNodeName){const imagesmissingalt=await(0,_str.get_string)("imagesmissingalt",_common.component);list+=await this.addWarnings(imagesmissingalt,this.checkImage(),!0)}if(null===selectedNodeName||"img"!==selectedNodeName&&"table"!==selectedNodeName){const needsmorecontrast=await(0,_str.get_string)("needsmorecontrast",_common.component);list+=await this.addWarnings(needsmorecontrast,this.checkOtherElements(selectedNodeName),!1)}if(this.editor.getContent({format:"text"}).length>1e3&&this.editor.dom.select("h3,h4,h5").length<1){const needsmoreheadings=await(0,_str.get_string)("needsmoreheadings",_common.component);list+=await this.addWarnings(needsmoreheadings,[this.editor],!1)}if(null===selectedNodeName||"table"===selectedNodeName){const tablesmissingcaption=await(0,_str.get_string)("tablesmissingcaption",_common.component);list+=await this.addWarnings(tablesmissingcaption,this.checkTableCaption(),!1);const tableswithmergedcells=await(0,_str.get_string)("tableswithmergedcells",_common.component);list+=await this.addWarnings(tableswithmergedcells,this.checkTableMergedCells(),!1);const tablesmissingheaders=await(0,_str.get_string)("tablesmissingheaders",_common.component);list+=await this.addWarnings(tablesmissingheaders,this.checkTableHeaders(),!1)}return""===list&&(list=await _templates.default.render("tiny_accessibilitychecker/success",{message:await(0,_str.get_string)(this.selectedNode?"nowarningonselected":"nowarnings",_common.component)})),list})),_defineProperty(this,"checkImage",(()=>{let problemNodes=[],index=0;return this.editor.dom.select("img").forEach((img=>{img.setAttribute("nodeId",index);let alt=img.getAttribute("alt");void 0!==alt&&""!==alt&&null!==alt||"presentation"!==img.getAttribute("role")&&problemNodes.push(img),index+=1})),problemNodes})),_defineProperty(this,"checkTableCaption",(()=>{let problemNodes=[],index=0;return this.editor.dom.select("table").forEach((function(table){table.setAttribute("nodeId",index);let caption=table.querySelector("caption");null!==caption&&""!==caption.textContent.trim()||problemNodes.push(table),index+=1})),problemNodes})),_defineProperty(this,"checkOtherElements",(node=>{let problemNodes=[],index=0;return this.editor.dom.select(null!=node?node:"body").forEach((node=>{let foreground,background,ratio,lum1,lum2;if(node.setAttribute("nodeId",index),""!==node.textContent.trim()&&(foreground=this.colorBase.fromArray(this.getComputedBackgroundColor(node,window.getComputedStyle(node,null).getPropertyValue("color")),this.colorBase.TYPES.RGBA),background=this.colorBase.fromArray(this.getComputedBackgroundColor(node),this.colorBase.TYPES.RGBA),lum1=this.getLuminanceFromCssColor(foreground),lum2=this.getLuminanceFromCssColor(background),ratio=lum1>lum2?(lum1+.05)/(lum2+.05):(lum2+.05)/(lum1+.05),ratio<=4.5)){window.console.log("\n                        Contrast ratio is too low: ".concat(ratio,"\n                        Colour 1: ").concat(foreground,"\n                        Colour 2: ").concat(background,"\n                        Luminance 1: ").concat(lum1,"\n                        Luminance 2: ").concat(lum2,"\n                    "));let i=0,found=!1;for(i=0;i<problemNodes.length;i++){if(-1!==node.parentElement.indexOf(problemNodes[i])){found=!0;break}if(-1!==problemNodes[i].parentElement.indexOf(node)){problemNodes[i]=node,found=!0;break}}found||problemNodes.push(node)}index+=1})),problemNodes})),_defineProperty(this,"checkTableMergedCells",(()=>{let problemNodes=[],index=0;return this.editor.dom.select("table").forEach((table=>{table.setAttribute("nodeId",index),table.querySelectorAll("[colspan], [rowspan]").length>0&&problemNodes.push(table),index+=1})),problemNodes})),_defineProperty(this,"checkTableHeaders",(()=>{let problemNodes=[],index=0;return this.editor.dom.select("table").forEach((function(table){if(table.setAttribute("nodeId",index),table.querySelectorAll("tr, td"))table.querySelectorAll("tr").forEach((row=>{let header=row.querySelector("th");header&&""!==header.textContent.trim()||problemNodes.push(table)}));else{let hasHeader=!1;table.querySelector("tr").querySelectorAll("th").some((header=>(hasHeader=!0,""===header.textContent.trim()&&(problemNodes.push(table),!0)))),hasHeader||problemNodes.push(table)}index+=1})),problemNodes})),_defineProperty(this,"addWarnings",(async(description,nodes,imagewarnings)=>{if(nodes.length>0){let text,img,faillist="";for(let i=0;i<nodes.length;i++){if(imagewarnings)img=nodes[i].getAttribute("src");else{var _text;if("innerText"in nodes[i]?text=nodes[i].innerText.trim():"textContent"in nodes[i]&&(text=nodes[i].textContent.trim()),""===text&&(text=await(0,_str.get_string)("emptytext",_common.component)),nodes[i]===this.editor){text=await(0,_str.get_string)("entiredocument",_common.component);const parentnode=nodes[i].dom.select("body")[0].childNodes;let nodelist="";parentnode.forEach((childnode=>{nodelist+=""===nodelist?childnode.nodeName.toLowerCase():","+childnode.nodeName.toLowerCase()})),nodes[i]=nodelist}text=null!==(_text=text)&&void 0!==_text?_text:nodes[i].nodeName}faillist+=await _templates.default.render("tiny_accessibilitychecker/list",{sourceNode:"string"==typeof nodes[i]?nodes[i]:nodes[i].nodeName.toLowerCase(),nodeId:nodes[i].getAttribute("nodeId"),text:text,img:img})}return await _templates.default.render("tiny_accessibilitychecker/warning",{html:faillist,description:description})}return""})),_defineProperty(this,"getLuminanceFromCssColor",(colortext=>{let color;"transparent"===colortext&&(colortext="#ffffff"),color=this.colorBase.toArray(this.colorBase.toRGB(colortext));let part1=function(a){return(a=parseInt(a,10)/255)<=.03928?a/=12.92:a=Math.pow((a+.055)/1.055,2.4),a};return.2126*part1(color[0])+.7152*part1(color[1])+.0722*part1(color[2])})),_defineProperty(this,"getComputedBackgroundColor",((node,color)=>{"transparent"===(color=color||window.getComputedStyle(node,null).getPropertyValue("background-color")).toLowerCase()&&(color="rgba(1, 1, 1, 0)");let colorParts=this.colorBase.toArray(color),alpha=colorParts[3];if(1===alpha)return colorParts;let parentColor=this.getComputedBackgroundColor(node.parentNode);return[(1-alpha)*parentColor[0]+alpha*colorParts[0],(1-alpha)*parentColor[1]+alpha*colorParts[1],(1-alpha)*parentColor[2]+alpha*colorParts[2],1]})),this.editor=editor,this.colorBase=new _colorbase.ColorBase,this.selectedNode=null,this.modal=null}}}));

//# sourceMappingURL=checker.min.js.map