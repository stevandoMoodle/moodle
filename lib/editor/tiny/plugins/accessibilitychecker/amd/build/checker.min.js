define("tiny_accessibilitychecker/checker",["exports","core/templates","core/str","core/notification","./common","core/modal_factory","core/modal_events","./colorbase"],(function(_exports,_templates,_str,_notification,_common,Modal,ModalEvents,_colorbase){var obj;
/*
   * @package    tiny_accessibilitychecker
   * @copyright  2022, Stevani Andolo  <stevani@hotmail.com.au>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_templates=(obj=_templates)&&obj.__esModule?obj:{default:obj},Modal=_interopRequireWildcard(Modal),ModalEvents=_interopRequireWildcard(ModalEvents);return _exports.default=class{constructor(editor){this.editor=editor,this.colorBase=new _colorbase.ColorBase,this.selectedNode=null,this.modal=null}async displayDialogue(){await this.setSelectedNode(),Modal.create({type:Modal.types.DEFAULT,large:!0,title:(0,_str.get_string)("pluginname",_common.component),body:this.getDialogueContent()}).then((modal=>(this.modal=modal,modal.getRoot().on(ModalEvents.hidden,(()=>{(!this.selectedNode||this.selectedNode&&!["TD","TABLE"].includes(this.selectedNode.nodeName))&&(this.selectedNode&&this.selectAndScroll(this.selectedNode),this.editor.dom.select("body")[0].focus()),modal.destroy(),this.selectedNode=null})),modal.show(),modal))).catch()}async setSelectedNode(){var _this$selectedNode,_this$selectedNode2,_this$selectedNode3,_this$selectedNode4,_this$selectedNode5;const selectedNode=this.editor.selection.getNode();if("BODY"!==selectedNode.nodeName&&(this.selectedNode=selectedNode),("P"===(null===(_this$selectedNode=this.selectedNode)||void 0===_this$selectedNode?void 0:_this$selectedNode.nodeName)&&""===(null===(_this$selectedNode2=this.selectedNode)||void 0===_this$selectedNode2?void 0:_this$selectedNode2.textContent)||"BR"===(null===(_this$selectedNode3=this.selectedNode)||void 0===_this$selectedNode3?void 0:_this$selectedNode3.nodeName)||"BR"===(null===(_this$selectedNode4=this.selectedNode)||void 0===_this$selectedNode4?void 0:_this$selectedNode4.nodeName)&&null!==(_this$selectedNode5=this.selectedNode)&&void 0!==_this$selectedNode5&&_this$selectedNode5.hasAttribute("data-mce-bogus"))&&(this.selectedNode=null),this.selectedNode){const checkAll=await this.checkConfirmation();this.selectedNode=checkAll?null:this.selectedNode}}async checkConfirmation(){try{return await(0,_notification.saveCancelPromise)((0,_str.get_string)("check_title",_common.component),(0,_str.get_string)("check_desc",_common.component),(0,_str.get_string)("confirm_yes",_common.component)),!0}catch{return!1}}async getDialogueContent(){let currentdesc="",warnings=[];const promises=this.getWarnings().map((async top=>{let object=[];top.map((async warning=>{var _warning$key,_warning$text;null!==(_warning$key=warning.key)&&void 0!==_warning$key&&_warning$key.includes(":stringlang")&&(warning.key=warning.key.split(":stringlang")[0]),currentdesc=currentdesc===warning.key?currentdesc:warning.key,null!==(_warning$text=warning.text)&&void 0!==_warning$text&&_warning$text.includes(":stringlang")&&(warning.text=await(0,_str.get_string)(warning.text.split(":stringlang")[0],_common.component)),object.push(warning)})),warnings.push({description:await(0,_str.get_string)(currentdesc,_common.component),dataobject:object})}));await Promise.all(promises);const content=await _templates.default.render("tiny_accessibilitychecker/warning_content",{data:warnings}),parsedHtml=this.parseHtml(content);return this.setSelectionListener(parsedHtml)}parseHtml(html){return(new DOMParser).parseFromString(html,"text/html").body.firstElementChild}setSelectionListener(content){return content.querySelectorAll("a").forEach((anchor=>{anchor.addEventListener("click",(e=>{e.preventDefault();const node=e.currentTarget.getAttribute("sourceNode");let nodeId=e.currentTarget.getAttribute("nodeId");nodeId="null"===nodeId?0:nodeId,node&&(node.includes(",")||"body"===node?this.selectAndScroll(this.editor.dom.select("body")[0]):this.selectAndScroll(this.editor.dom.select(node)[nodeId])),this.closeModal()}))})),content}selectAndScroll(node){this.selectedNode=node,this.editor.selection.select(node).scrollIntoView({behavior:"smooth",block:"nearest"})}closeModal(){this.modal.destroy()}getWarnings(){let warnings=[],selectedNodeName=this.selectedNode?this.selectedNode.nodeName.toLowerCase():null;if(selectedNodeName="td"===selectedNodeName?"table":selectedNodeName,null===selectedNodeName||"img"===selectedNodeName){const warning=this.createWarning("imagesmissingalt",this.checkImage(),!0);warning.length>0&&warnings.push(warning)}if(null===selectedNodeName||"img"!==selectedNodeName&&"table"!==selectedNodeName){const warning=this.createWarning("needsmorecontrast",this.checkOtherElements(selectedNodeName),!1);warning.length>0&&warnings.push(warning)}if(this.editor.getContent({format:"text"}).length>1e3&&this.editor.dom.select("h3,h4,h5").length<1){const warning=this.createWarning("needsmoreheadings",[this.editor],!1);warning.length>0&&warnings.push(warning)}if(null===selectedNodeName||"table"===selectedNodeName){const capwarning=this.createWarning("tablesmissingcaption",this.checkTableCaption(),!1);capwarning.length>0&&warnings.push(capwarning);const mergedwarning=this.createWarning("tableswithmergedcells",this.checkTableMergedCells(),!1);mergedwarning.length>0&&warnings.push(mergedwarning);const headerwarning=this.createWarning("tablesmissingheaders",this.checkTableHeaders(),!1);headerwarning.length>0&&warnings.push(headerwarning)}return warnings.length<1&&warnings.push([{key:this.selectedNode?"nowarningonselected:stringlang":"nowarnings:stringlang",nowarning:!0}]),warnings}createWarning(description,nodes,imagewarnings){let text,src,warnings=[];for(let i=0;i<nodes.length;i++){if(imagewarnings)src=nodes[i].getAttribute("src");else{var _text;if("innerText"in nodes[i]?text=nodes[i].innerText.trim():"textContent"in nodes[i]&&(text=nodes[i].textContent.trim()),""===text&&(text="emptytext:stringlang"),nodes[i]===this.editor){text="entiredocument:stringlang";const childnodes=nodes[i].dom.select("body")[0].childNodes;childnodes.length>1?nodes[i]="body":nodes[i]=childnodes.nodeName.toLowerCase()}text=null!==(_text=text)&&void 0!==_text?_text:nodes[i].nodeName}warnings.push({key:description,sourceNode:"string"==typeof nodes[i]?nodes[i]:nodes[i].nodeName.toLowerCase(),nodeId:nodes[i].getAttribute("nodeId"),text:text,img:src})}return warnings}checkImage(){let problemNodes=[],index=0;return this.editor.dom.select("img").forEach((img=>{img.setAttribute("nodeId",index);let alt=img.getAttribute("alt");void 0!==alt&&""!==alt&&null!==alt||"presentation"!==img.getAttribute("role")&&problemNodes.push(img),index+=1})),problemNodes}checkTableCaption(){let problemNodes=[],index=0;return this.editor.dom.select("table").forEach((function(table){table.setAttribute("nodeId",index);let caption=table.querySelector("caption");null!==caption&&""!==caption.textContent.trim()||problemNodes.push(table),index+=1})),problemNodes}checkOtherElements(node){let problemNodes=[],index=0;return this.editor.dom.select(null!=node?node:"body").forEach((node=>{let foreground,background,ratio,lum1,lum2;if(node.setAttribute("nodeId",index),""!==node.textContent.trim()&&(foreground=this.colorBase.fromArray(this.getComputedBackgroundColor(node,window.getComputedStyle(node,null).getPropertyValue("color")),this.colorBase.TYPES.RGBA),background=this.colorBase.fromArray(this.getComputedBackgroundColor(node),this.colorBase.TYPES.RGBA),lum1=this.getLuminanceFromCssColor(foreground),lum2=this.getLuminanceFromCssColor(background),ratio=lum1>lum2?(lum1+.05)/(lum2+.05):(lum2+.05)/(lum1+.05),ratio<=4.5)){window.console.log("\n                        Contrast ratio is too low: ".concat(ratio,"\n                        Colour 1: ").concat(foreground,"\n                        Colour 2: ").concat(background,"\n                        Luminance 1: ").concat(lum1,"\n                        Luminance 2: ").concat(lum2,"\n                    "));let i=0,found=!1;for(i=0;i<problemNodes.length;i++){if(-1!==node.parentElement.indexOf(problemNodes[i])){found=!0;break}if(-1!==problemNodes[i].parentElement.indexOf(node)){problemNodes[i]=node,found=!0;break}}found||problemNodes.push(node)}index+=1})),problemNodes}checkTableMergedCells(){let problemNodes=[],index=0;return this.editor.dom.select("table").forEach((table=>{table.setAttribute("nodeId",index),table.querySelectorAll("[colspan], [rowspan]").length>0&&problemNodes.push(table),index+=1})),problemNodes}checkTableHeaders(){let problemNodes=[],index=0;return this.editor.dom.select("table").forEach((function(table){if(table.setAttribute("nodeId",index),table.querySelectorAll("tr, td"))table.querySelectorAll("tr").forEach((row=>{let header=row.querySelector("th");header&&""!==header.textContent.trim()||problemNodes.push(table)}));else{let hasHeader=!1;table.querySelector("tr").querySelectorAll("th").some((header=>(hasHeader=!0,""===header.textContent.trim()&&(problemNodes.push(table),!0)))),hasHeader||problemNodes.push(table)}index+=1})),problemNodes}getLuminanceFromCssColor(colortext){let color;"transparent"===colortext&&(colortext="#ffffff"),color=this.colorBase.toArray(this.colorBase.toRGB(colortext));let part1=function(a){return(a=parseInt(a,10)/255)<=.03928?a/=12.92:a=Math.pow((a+.055)/1.055,2.4),a};return.2126*part1(color[0])+.7152*part1(color[1])+.0722*part1(color[2])}getComputedBackgroundColor(node,color){"transparent"===(color=color||window.getComputedStyle(node,null).getPropertyValue("background-color")).toLowerCase()&&(color="rgba(1, 1, 1, 0)");let colorParts=this.colorBase.toArray(color),alpha=colorParts[3];if(1===alpha)return colorParts;let parentColor=this.getComputedBackgroundColor(node.parentNode);return[(1-alpha)*parentColor[0]+alpha*colorParts[0],(1-alpha)*parentColor[1]+alpha*colorParts[1],(1-alpha)*parentColor[2]+alpha*colorParts[2],1]}},_exports.default}));

//# sourceMappingURL=checker.min.js.map