{"version":3,"file":"plugin.min.js","sources":["../src/plugin.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny Media plugin for Moodle.\n *\n * @module      tiny_media/plugin\n * @copyright   2022 Andrew Lyons <andrew@nicols.co.uk>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport {getTinyMCE} from 'editor_tiny/loader';\nimport {\n    saveCancel,\n} from 'core/notification';\n\nimport uploadHandler from './upload-handler';\n\nconst askTheQuestion = (editor, question) => {\n    saveCancel('Title', question, 'Yes', () => {\n        editor.setContent('<span data-identifier=\"SOMEVALUE\">' + editor.getContent() + '</span>');\n        editor.insertContent('Inserted some content! :)');\n    });\n};\n\nconst isNullable = a => a === null || a === undefined;\nconst isNonNullable = a => !isNullable(a);\nconst isPlaceholderImage = (imgElm) => (\n    imgElm.nodeName === 'IMG' && (imgElm.hasAttribute('data-mce-object') || imgElm.hasAttribute('data-mce-placeholder'))\n);\n\nconst getSelectedImage = editor => {\n    const imgElm = editor.selection.getNode();\n    const figureElm = editor.dom.getParent(imgElm, 'figure.image');\n    if (figureElm) {\n        return editor.dom.select('img', figureElm)[0];\n    }\n    if (imgElm && (imgElm.nodeName !== 'IMG' || isPlaceholderImage(imgElm))) {\n        return null;\n    }\n    return imgElm;\n};\n\n// Display a dialogue\nexport default new Promise(async(resolve) => {\n    const tinyMCE = await getTinyMCE();\n\n    tinyMCE.PluginManager.add('tiny_media/plugin', (editor) => {\n        // Add a button which asks the question.\n        editor.ui.registry.addButton('tiny_media/image', {\n            icon: 'image',\n            text: 'Image...',\n            onAction: function() {\n                askTheQuestion(editor, 'Did you click the button?');\n            }\n        });\n\n        // Add a menu item which asks the question.\n        editor.ui.registry.addMenuItem('tiny_media/image', {\n            icon: 'image',\n            text: 'Image...',\n            onAction: function() {\n                askTheQuestion(editor, 'Did you click the Menu item?');\n            }\n        });\n\n        editor.ui.registry.addToggleButton('tiny_media/imageimage', {\n            icon: 'image',\n            tooltip: 'Insert/edit image',\n            onAction: () => {\n                askTheQuestion(editor, 'Did you click the Menu item?');\n            },\n            onSetup: (buttonApi) => {\n                buttonApi.setActive(isNonNullable(getSelectedImage(editor)));\n                return editor.selection.selectorChangedWithUnbind(\n                    'img:not([data-mce-object]):not([data-mce-placeholder]),figure.image',\n                    buttonApi.setActive\n                ).unbind;\n            }\n        });\n\n        // Add a button which asks the question.\n        editor.ui.registry.addButton('tiny_media/video', {\n            text: 'Video',\n            onAction: function() {\n                askTheQuestion(editor, 'Did you click the button?');\n            }\n        });\n\n        // Add a menu item which asks the question.\n        editor.ui.registry.addMenuItem('tiny_media/video', {\n            text: 'Insert video',\n            onAction: function() {\n                askTheQuestion(editor, 'Did you click the Menu item?');\n            }\n        });\n\n        return {\n            name: 'Media plugin',\n            url: 'https://moodle.org/'\n        };\n    });\n\n    resolve(['tiny_media/plugin', {\n        configure: () => ({\n            // eslint-disable-next-line\n            images_upload_handler: (blobInfo, progress) => uploadHandler(tinyMCE.activeEditor, blobInfo, progress),\n\n            // eslint-disable-next-line\n            file_picker_callback: (cb, value, meta) => {\n                const editor = tinyMCE.activeEditor;\n                if (editor.moodleOptions.filepicker[meta.filetype]) {\n                    const options = {\n                        ...editor.moodleOptions.filepicker[meta.filetype],\n                        formcallback: (newFile) => {\n                            cb(newFile.url, {\n                                alt: newFile.file,\n                            });\n                        }\n                    };\n                    M.core_filepicker.show(Y, options);\n                }\n            },\n\n        })\n    }]);\n\n    return tinyMCE;\n});\n"],"names":["askTheQuestion","editor","question","setContent","getContent","insertContent","Promise","async","tinyMCE","PluginManager","add","ui","registry","addButton","icon","text","onAction","addMenuItem","addToggleButton","tooltip","onSetup","buttonApi","a","setActive","imgElm","selection","getNode","figureElm","dom","getParent","select","nodeName","hasAttribute","isPlaceholderImage","getSelectedImage","isNullable","selectorChangedWithUnbind","unbind","name","url","resolve","configure","images_upload_handler","blobInfo","progress","activeEditor","file_picker_callback","cb","value","meta","moodleOptions","filepicker","filetype","options","formcallback","newFile","alt","file","M","core_filepicker","show","Y"],"mappings":";;;;;;;iKA6BMA,eAAiB,CAACC,OAAQC,yCACjB,QAASA,SAAU,OAAO,KACjCD,OAAOE,WAAW,qCAAuCF,OAAOG,aAAe,WAC/EH,OAAOI,cAAc,8CAuBd,IAAIC,SAAQC,MAAAA,gBACjBC,cAAgB,+BAEtBA,QAAQC,cAAcC,IAAI,qBAAsBT,SAE5CA,OAAOU,GAAGC,SAASC,UAAU,mBAAoB,CAC7CC,KAAM,QACNC,KAAM,WACNC,SAAU,WACNhB,eAAeC,OAAQ,gCAK/BA,OAAOU,GAAGC,SAASK,YAAY,mBAAoB,CAC/CH,KAAM,QACNC,KAAM,WACNC,SAAU,WACNhB,eAAeC,OAAQ,mCAI/BA,OAAOU,GAAGC,SAASM,gBAAgB,wBAAyB,CACxDJ,KAAM,QACNK,QAAS,oBACTH,SAAU,KACNhB,eAAeC,OAAQ,iCAE3BmB,QAAUC,YA9CAC,IAAAA,SA+CND,UAAUE,WA/CJD,EAKGrB,CAAAA,eACfuB,OAASvB,OAAOwB,UAAUC,UAC1BC,UAAY1B,OAAO2B,IAAIC,UAAUL,OAAQ,uBAC3CG,UACO1B,OAAO2B,IAAIE,OAAO,MAAOH,WAAW,GAE3CH,SAA+B,QAApBA,OAAOO,UAVEP,CAAAA,QACJ,QAApBA,OAAOO,WAAuBP,OAAOQ,aAAa,oBAAsBR,OAAOQ,aAAa,yBAShDC,CAAmBT,SACpD,KAEJA,QAiCuCU,CAAiBjC,SAhDhDqB,CAAAA,GAAKA,MAAAA,EACIa,CAAWb,KAgDhBrB,OAAOwB,UAAUW,0BACpB,sEACAf,UAAUE,WACZc,UAKVpC,OAAOU,GAAGC,SAASC,UAAU,mBAAoB,CAC7CE,KAAM,QACNC,SAAU,WACNhB,eAAeC,OAAQ,gCAK/BA,OAAOU,GAAGC,SAASK,YAAY,mBAAoB,CAC/CF,KAAM,eACNC,SAAU,WACNhB,eAAeC,OAAQ,mCAIxB,CACHqC,KAAM,eACNC,IAAK,0BAIbC,QAAQ,CAAC,oBAAqB,CAC1BC,UAAW,MAEPC,sBAAuB,CAACC,SAAUC,YAAa,0BAAcpC,QAAQqC,aAAcF,SAAUC,UAG7FE,qBAAsB,CAACC,GAAIC,MAAOC,cACxBhD,OAASO,QAAQqC,gBACnB5C,OAAOiD,cAAcC,WAAWF,KAAKG,UAAW,OAC1CC,QAAU,IACTpD,OAAOiD,cAAcC,WAAWF,KAAKG,UACxCE,aAAeC,UACXR,GAAGQ,QAAQhB,IAAK,CACZiB,IAAKD,QAAQE,SAIzBC,EAAEC,gBAAgBC,KAAKC,EAAGR,gBAOnC7C"}