{"version":3,"file":"embedhandler.min.js","sources":["../../src/embed/embedhandler.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny media plugin embed handler class.\n *\n * This handles anything that embed requires like:\n * - Calling the media preview in embedPreview.\n * - Loading the embed insert.\n * - Getting selected media data.\n * - Handles url and repository uploads.\n * - Reset embed insert when embed preview is deleted.\n * - Handles media embedding into tiny and etc.\n *\n * @module      tiny_media/embed/embedhandler\n * @copyright   2024 Stevani Andolo <stevani@hotmail.com.au>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Selectors from \"../selectors\";\nimport {EmbedInsert} from './embedinsert';\nimport {\n    body,\n    footer,\n    setPropertiesFromData,\n    hideElements,\n    isValidUrl,\n    convertStringUrlToObject,\n    stopMediaLoading,\n} from '../helpers';\nimport * as ModalEvents from 'core/modal_events';\nimport {displayFilepicker} from 'editor_tiny/utils';\nimport {\n    insertMediaTemplateContext,\n    getHelpStrings,\n    prepareMoodleLang,\n} from \"./embedhelpers\";\n\nexport class EmbedHandler {\n\n    constructor(data) {\n        setPropertiesFromData(this, data); // Creates dynamic properties based on \"data\" param.\n    }\n\n    /**\n     * Load the media insert dialogue.\n     *\n     * @param {object} templateContext Object template context\n     */\n    loadTemplatePromise = (templateContext) => {\n        templateContext.elementid = this.editor.id;\n        templateContext.bodyTemplate = Selectors.EMBED.template.body.insertMediaBody;\n        templateContext.footerTemplate = Selectors.EMBED.template.footer.insertMediaFooter;\n        templateContext.selector = 'EMBED';\n\n        Promise.all([body(templateContext, this.root), footer(templateContext, this.root)])\n            .then(() => {\n                (new EmbedInsert(this)).init();\n                return;\n            })\n            .catch(error => {\n                window.console.log(error);\n            });\n    };\n\n    /**\n     * Loads the media preview dialogue.\n     *\n     * @param {object} embedPreview Object of embedPreview\n     * @param {object} templateContext Object of template context\n     */\n    loadMediaDetails = async(embedPreview, templateContext) => {\n        Promise.all([body(templateContext, this.root), footer(templateContext, this.root)])\n            .then(() => {\n                // Hide the body template when preparing the media preview.\n                hideElements(Selectors.EMBED.elements.bodyTemplate, this.root);\n\n                if (this.mediaData) { // It came from mediaThumbnail and we should kill uploadThumbnailModal modal.\n                    this.currentModal.uploadThumbnailModal.destroy();\n                    const currentModal = this.currentModal.insertMediaModal;\n                    this.currentModal = currentModal.insertMediaModal;\n                }\n                embedPreview.init();\n                return;\n            })\n            .catch(error => {\n                if (!this.mediaData) { // It came from mediaThumbnail and we did not init startMediaLoading from there.\n                    stopMediaLoading(this.root, 'EMBED');\n                }\n                window.console.log(error);\n            });\n    };\n\n    /**\n     * Reset the media insert modal form.\n     */\n    resetUploadForm = () => {\n        this.mediaType = null; // Set to null to be set again.\n        this.loadTemplatePromise(insertMediaTemplateContext(this));\n    };\n\n    /**\n     * Get selected media data.\n     *\n     * @returns {null|object}\n     */\n    getMediumProperties = () => {\n        const boolAttr = (elem, attr) => {\n            // As explained in MDL-64175, some OS (like Ubuntu), are removing the value for these attributes.\n            // So in order to check if attr=\"true\", we need to check if the attribute exists and if the value is empty or true.\n            return (elem.hasAttribute(attr) && (elem.getAttribute(attr) || elem.getAttribute(attr) === ''));\n        };\n\n        const medium = this.selectedMedia;\n        if (!medium) {\n            return null;\n        }\n\n        const isLink = (this.mediaType === 'link');\n        if (isLink) {\n            const urlParams = convertStringUrlToObject(medium.href);\n            const mediaData = {\n                type: this.mediaType,\n                title: medium.textContent.trim(),\n            };\n\n            for (const param in urlParams) {\n                let prop = param;\n                if (param === 'mute') {\n                    prop = 'muted';\n                }\n                const isTrue = (urlParams[param] === 'true') || (urlParams[param] === '1');\n                mediaData[prop] = isTrue;\n            }\n            return mediaData;\n        } else {\n            const tracks = {\n                subtitles: [],\n                captions: [],\n                descriptions: [],\n                chapters: [],\n                metadata: []\n            };\n            const sources = [];\n\n            medium.querySelectorAll('track').forEach((track) => {\n                tracks[track.getAttribute('kind')].push({\n                    src: track.getAttribute('src'),\n                    srclang: track.getAttribute('srclang'),\n                    label: track.getAttribute('label'),\n                    defaultTrack: boolAttr(track, 'default')\n                });\n            });\n\n            medium.querySelectorAll('source').forEach((source) => {\n                sources.push(source.src);\n            });\n            const title = medium.getAttribute('title');\n\n            return {\n                type: this.mediaType,\n                sources,\n                poster: medium.getAttribute('poster'),\n                title: title ? title.trim() : false,\n                width: medium.getAttribute('width'),\n                height: medium.getAttribute('height'),\n                autoplay: boolAttr(medium, 'autoplay'),\n                loop: boolAttr(medium, 'loop'),\n                muted: boolAttr(medium, 'muted'),\n                controls: boolAttr(medium, 'controls'),\n                tracks,\n            };\n        }\n    };\n\n    /**\n     * Get selected media data.\n     *\n     * @returns {object}\n     */\n    getCurrentEmbedData = () => {\n        const properties = this.getMediumProperties();\n        if (!properties) {\n            return {};\n        }\n\n        const processedProperties = {};\n        processedProperties.media = properties;\n        processedProperties.link = false;\n\n        return processedProperties;\n    };\n\n    /**\n     * Get help strings for media subtitles and captions.\n     *\n     * @returns {null|object}\n     */\n    getHelpStrings = async() => {\n        if (!this.helpStrings) {\n            this.helpStrings = await getHelpStrings();\n        }\n\n        return this.helpStrings;\n    };\n\n    /**\n     * Set template context for insert media dialogue.\n     *\n     * @param {object} data Object of media data\n     * @returns {object}\n     */\n    getTemplateContext = async(data) => {\n        const languages = prepareMoodleLang(this.editor);\n        const helpIcons = Array.from(Object.entries(await this.getHelpStrings())).forEach(([key, text]) => {\n            data[`${key.toLowerCase()}helpicon`] = {text};\n        });\n\n        return Object.assign({}, {\n            elementid: this.editor.getElement().id,\n            showFilePickerTrack: this.canShowFilePickerTrack,\n            langsInstalled: languages.installed,\n            langsAvailable: languages.available,\n            media: true,\n            isUpdating: this.isUpdating,\n        }, data, helpIcons);\n    };\n\n    /**\n     * Set and get media template context.\n     *\n     * @param {null|object} data Null or object of media data\n     * @returns {Promise<object>} A promise that resolves template context.\n     */\n    getMediaTemplateContext = async(data = null) => {\n        if (!data) {\n            data = Object.assign({}, this.getCurrentEmbedData());\n        }\n        this.isUpdating = Object.keys(data).length !== 0;\n        return await this.getTemplateContext(data);\n    };\n\n    /**\n     * Handles changes in the media URL input field and loads a preview of the media if the URL has changed.\n     */\n    urlChanged() {\n        hideElements(Selectors.EMBED.elements.urlWarning, this.root);\n        const url = this.root.querySelector(Selectors.EMBED.elements.fromUrl).value;\n        if (url && url !== this.currentUrl) {\n            this.loadMediaPreview(url);\n        }\n    }\n\n    /**\n     * Load the media preview dialogue.\n     *\n     * @param {string} url String of media url\n     */\n    loadMediaPreview = (url) => {\n        (new EmbedInsert(this)).loadMediaPreview(url);\n    };\n\n    /**\n     * Callback for file picker that previews the media or add the captions and subtitles.\n     *\n     * @param {object} params Object of media url and etc\n     */\n    trackFilePickerCallback(params) {\n        if (params.url !== '') {\n            this.loadMediaPreview(params.url);\n        }\n    }\n\n    /**\n     * Handle click events.\n     *\n     * @param {html} e Selected element\n     */\n    clickHandler = async(e) => {\n        const element = e.target;\n\n        const mediaBrowser = element.closest(Selectors.EMBED.actions.mediaBrowser);\n        if (mediaBrowser) {\n            e.preventDefault();\n            const params = await displayFilepicker(this.editor, 'media');\n            this.trackFilePickerCallback(params);\n        }\n\n        const addUrlEle = e.target.closest(Selectors.EMBED.actions.addUrl);\n        if (addUrlEle) {\n            this.urlChanged();\n        }\n    };\n\n    /**\n     * Enables or disables the URL-related buttons in the footer based on the current URL and input value.\n     *\n     * @param {html} input Url input field\n     */\n    toggleUrlButton(input) {\n        const url = input.value;\n        const addUrl = this.root.querySelector(Selectors.EMBED.actions.addUrl);\n        addUrl.disabled = !(url !== \"\" && isValidUrl(url));\n    }\n\n    registerEventListeners = async(modal) => {\n        await modal.getBody();\n        const $root = modal.getRoot();\n        const root = $root[0];\n        if (this.canShowFilePickerTrack) {\n            root.addEventListener('click', this.clickHandler.bind(this));\n        }\n\n        root.addEventListener('input', (e) => {\n            const urlEle = e.target.closest(Selectors.EMBED.elements.fromUrl);\n            if (urlEle) {\n                this.toggleUrlButton(urlEle);\n            }\n        });\n\n        $root.on(ModalEvents.hidden, () => {\n            this.currentModal.destroy();\n        });\n    };\n}\n"],"names":["constructor","data","templateContext","elementid","this","editor","id","bodyTemplate","Selectors","EMBED","template","body","insertMediaBody","footerTemplate","footer","insertMediaFooter","selector","Promise","all","root","then","EmbedInsert","init","catch","error","window","console","log","async","embedPreview","elements","mediaData","currentModal","uploadThumbnailModal","destroy","insertMediaModal","mediaType","loadTemplatePromise","boolAttr","elem","attr","hasAttribute","getAttribute","medium","selectedMedia","urlParams","href","type","title","textContent","trim","param","prop","isTrue","tracks","subtitles","captions","descriptions","chapters","metadata","sources","querySelectorAll","forEach","track","push","src","srclang","label","defaultTrack","source","poster","width","height","autoplay","loop","muted","controls","properties","getMediumProperties","processedProperties","media","link","helpStrings","languages","helpIcons","Array","from","Object","entries","getHelpStrings","_ref","key","text","toLowerCase","assign","getElement","showFilePickerTrack","canShowFilePickerTrack","langsInstalled","installed","langsAvailable","available","isUpdating","_this","getCurrentEmbedData","keys","length","getTemplateContext","url","loadMediaPreview","e","target","closest","actions","mediaBrowser","preventDefault","params","trackFilePickerCallback","addUrl","urlChanged","modal","getBody","$root","getRoot","addEventListener","clickHandler","bind","urlEle","fromUrl","toggleUrlButton","on","ModalEvents","hidden","urlWarning","querySelector","value","currentUrl","input","disabled"],"mappings":"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"}