{"version":3,"file":"usedfiles.min.js","sources":["../src/usedfiles.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny Media Manager usedfiles.\n *\n * @module      tiny_mediamanager/usedfiles\n * @copyright   2022, Stevani Andolo <stevani@hotmail.com.au>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nconst usedFiles = (files, usercontext, itemid) => {\n    const CSS = {\n        HASMISSINGFILES: 'has-missing-files',\n        HASUNUSEDFILES: 'has-unused-files'\n    };\n\n    const SELECTORS = {\n        FILEANCESTOR: '.fitem',\n        FORM: '#tiny_mediamanager_form',\n        MISSINGFILES: '.missing-files'\n    };\n\n    // Return the list of files used in the area.\n    const getUsedFiles = () => {\n        let iframe = window.parent.document.getElementById('id_description_editor_ifr'),\n            content = iframe.contentWindow.document.getElementById('tinymce'),\n            baseUrl = `${M.cfg.wwwroot}/draftfile.php/${_usercontext}/user/draft/${_itemid}/`,\n            pattern = new RegExp(\"[\\\"']\" + baseUrl.replace(/[-/\\\\^$*+?.()|[\\]{}]/g, '\\\\$&') + \"(.+?)[\\\\?\\\"']\", 'gm'),\n            filename = '',\n            match = '',\n            usedFiles = {};\n\n        // The pattern matches any draftfile URL contained within quotes, e.g. 'src=\"<filename>\"' or 'href=\"<filename>\"'.\n        while ((match = pattern.exec(content.innerHTML)) !== null) {\n            filename = decodeURIComponent(match[1]);\n            usedFiles[filename] = true;\n        }\n\n        return usedFiles;\n    };\n\n    // Return an array of unused files.\n    const findUnusedFiles = (allFiles, usedFiles) => {\n        let key,\n            list = [];\n        for (key in allFiles) {\n            if (!usedFiles[key]) {\n                list.push(key);\n            }\n        }\n        return list;\n    };\n\n    // Return an array of missing files.\n    const findMissingFiles = (allFiles, usedFiles) => {\n        let key,\n            list = [];\n        for (key in usedFiles) {\n            if (!allFiles[key]) {\n                list.push(key);\n            }\n        }\n        return list;\n    };\n\n    // Sanitizes any unsafe html.\n    const escapeHtml = (html) => {\n        return html\n         .replace(/&/g, \"&amp;\")\n         .replace(/</g, \"&lt;\")\n         .replace(/>/g, \"&gt;\")\n         .replace(/\"/g, \"&quot;\")\n         .replace(/'/g, \"&#039;\");\n    };\n\n    const _files = files,\n    _usercontext = usercontext,\n    _itemid = itemid,\n    form = document.querySelector(SELECTORS.FORM),\n    usedFiles = getUsedFiles(),\n    unusedFiles = findUnusedFiles(_files, usedFiles),\n    missingFiles = findMissingFiles(_files, usedFiles);\n\n    let missingFilesTxt = null,\n    i = null;\n\n    if (!form || !window.parent) {\n        window.console.log(\"Unable to find parent window\");\n        return;\n    }\n\n    // There are some unused files.\n    if (unusedFiles.length > 0) {\n        // Loop over all the files in the form.\n        form.querySelectorAll('input[type=checkbox][name^=\"deletefile\"]').forEach(function(node) {\n            // If the file is used, remove it.\n            if (unusedFiles.indexOf(node.getAttribute('data-filename')) === -1) {\n                node.closest(SELECTORS.FILEANCESTOR).remove();\n            }\n        });\n        form.classList.add(CSS.HASUNUSEDFILES);\n    } else {\n        // This is needed as the init may be called twice due to the double call to $PAGE->requires->js_call_amd().\n        form.classList.remove(CSS.HASUNUSEDFILES);\n    }\n\n    // There are some files missing.\n    if (missingFiles.length > 0) {\n        missingFilesTxt = '<ol>';\n        for (i = 0; i < missingFiles.length; i++) {\n            missingFilesTxt += `<li>${escapeHtml(missingFiles[i])}</li>`;\n        }\n        missingFilesTxt += '</ol>';\n        form.querySelector(SELECTORS.MISSINGFILES).innerHTML = missingFilesTxt;\n        form.classList.add(CSS.HASMISSINGFILES);\n    } else {\n        form.classList.remove(CSS.HASMISSINGFILES);\n    }\n};\n\nexport const init = (files, usercontext, itemid) => {\n    usedFiles(files, usercontext, itemid);\n};\n"],"names":["files","usercontext","itemid","CSS","SELECTORS","_files","_usercontext","_itemid","form","document","querySelector","usedFiles","content","window","parent","getElementById","contentWindow","baseUrl","M","cfg","wwwroot","pattern","RegExp","replace","match","exec","innerHTML","decodeURIComponent","getUsedFiles","unusedFiles","allFiles","key","list","push","findUnusedFiles","missingFiles","findMissingFiles","missingFilesTxt","i","length","querySelectorAll","forEach","node","indexOf","getAttribute","closest","remove","classList","add","console","log"],"mappings":"yJAqIoB,SAACA,MAAOC,YAAaC,SA9GvB,SAACF,MAAOC,YAAaC,YAC7BC,oBACe,oBADfA,mBAEc,mBAGdC,uBACY,SADZA,eAEI,0BAFJA,uBAGY,iBAwDZC,OAASL,MACfM,aAAeL,YACfM,QAAUL,OACVM,KAAOC,SAASC,cAAcN,gBAC9BO,UAxDqB,mBAEbC,QADSC,OAAOC,OAAOL,SAASM,eAAe,6BAC9BC,cAAcP,SAASM,eAAe,WACvDE,kBAAaC,EAAEC,IAAIC,kCAAyBd,oCAA2BC,aACvEc,QAAU,IAAIC,OAAO,QAAUL,QAAQM,QAAQ,wBAAyB,QAAU,gBAAiB,MAEnGC,MAAQ,GACRb,UAAY,GAGqC,QAA7Ca,MAAQH,QAAQI,KAAKb,QAAQc,aAEjCf,UADWgB,mBAAmBH,MAAM,MACd,SAGnBb,UAyCCiB,GACZC,YAtCwB,SAACC,SAAUnB,eAC3BoB,IACAC,KAAO,OACND,OAAOD,SACHnB,UAAUoB,MACXC,KAAKC,KAAKF,YAGXC,KA8BGE,CAAgB7B,OAAQM,WACtCwB,aA3ByB,SAACL,SAAUnB,eAC5BoB,IACAC,KAAO,OACND,OAAOpB,UACHmB,SAASC,MACVC,KAAKC,KAAKF,YAGXC,KAmBII,CAAiB/B,OAAQM,WAEpC0B,gBAAkB,KACtBC,EAAI,QAEC9B,MAASK,OAAOC,UAMjBe,YAAYU,OAAS,GAErB/B,KAAKgC,iBAAiB,4CAA4CC,SAAQ,SAASC,OAEd,IAA7Db,YAAYc,QAAQD,KAAKE,aAAa,mBACtCF,KAAKG,QAAQzC,wBAAwB0C,YAG7CtC,KAAKuC,UAAUC,IAAI7C,qBAGnBK,KAAKuC,UAAUD,OAAO3C,oBAItBgC,aAAaI,OAAS,EAAG,KACzBF,gBAAkB,OACbC,EAAI,EAAGA,EAAIH,aAAaI,OAAQD,IACjCD,+BAAqCF,aAAaG,GA1CpDf,QAAQ,KAAM,SACdA,QAAQ,KAAM,QACdA,QAAQ,KAAM,QACdA,QAAQ,KAAM,UACdA,QAAQ,KAAM,mBAwChBc,iBAAmB,QACnB7B,KAAKE,cAAcN,wBAAwBsB,UAAYW,gBACvD7B,KAAKuC,UAAUC,IAAI7C,0BAEnBK,KAAKuC,UAAUD,OAAO3C,0BA7BtBU,OAAOoC,QAAQC,IAAI,gCAkCvBvC,CAAUX,MAAOC,YAAaC"}