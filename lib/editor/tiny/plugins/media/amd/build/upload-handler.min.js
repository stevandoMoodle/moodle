define("tiny_media/upload-handler",["exports","core_form/events","editor_tiny/options"],(function(_exports,_events,_options){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0;return _exports.default=function(activeEditor,blobInfo,progress){return new Promise((function(resolve,reject){var _options$savepath;(0,_events.notifyUploadStarted)(activeEditor.targetElm.id);var xhr=new XMLHttpRequest;xhr.upload.addEventListener("progress",(function(e){progress(e.loaded/e.total*100)})),xhr.addEventListener("load",(function(){if(403!==xhr.status)if(xhr.status<200||xhr.status>=300)reject("HTTP Error: ".concat(xhr.status));else{var location,response=JSON.parse(xhr.responseText);if(response)(0,_events.notifyUploadCompleted)(activeEditor.targetElm.id),response.url?location=response.url:response.event&&"fileexists"===response.event&&response.newfile&&(location=response.newfile.url),location&&"string"==typeof location?resolve(location):reject("Unable to handle file result: ".concat(xhr.responseText));else reject("Invalid JSON: ".concat(xhr.responseText))}else reject({message:"HTTP error: ".concat(xhr.status),remove:!0})})),xhr.addEventListener("error",(function(){reject("Image upload failed due to an XHR transport error. Code: ".concat(xhr.status))}));var formData=new FormData,options=(0,_options.getFilePicker)(activeEditor,"image");formData.append("repo_upload_file",blobInfo.blob()),formData.append("itemid",options.itemid),Object.values(options.repositories).some((function(repository){return"upload"===repository.type&&(formData.append("repo_id",repository.id),!0)})),formData.append("env",options.env),formData.append("sesskey",M.cfg.sesskey),formData.append("client_id",options.client_id),formData.append("savepath",null!==(_options$savepath=options.savepath)&&void 0!==_options$savepath?_options$savepath:"/"),formData.append("ctx_id",options.context.id),xhr.open("POST","".concat(M.cfg.wwwroot,"/repository/repository_ajax.php?action=upload"),!0),xhr.send(formData)}))},_exports.default}));

//# sourceMappingURL=upload-handler.min.js.map