function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("core_courseformat/local/content/actions",["exports","core/reactive","core/modal_factory","core/modal_events","core/templates","core/prefetch","core/str","core/normalise","core_course/events","core/pending","core_courseformat/local/courseeditor/contenttree","jquery"],(function(_exports,_reactive,_modal_factory,_modal_events,_templates,_prefetch,_str,_normalise,CourseEvents,_pending,_contenttree,_jquery){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates),CourseEvents=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(CourseEvents),_pending=_interopRequireDefault(_pending),_contenttree=_interopRequireDefault(_contenttree),_jquery=_interopRequireDefault(_jquery),(0,_prefetch.prefetchStrings)("core",["movecoursesection","movecoursemodule","confirm","delete"]);var _default=function(_BaseComponent){!function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&_setPrototypeOf(subClass,superClass)}(_default,_BaseComponent);var Constructor,protoProps,staticProps,_requestDeleteSection2,_requestAddSection2,_requestMoveCm2,_requestMoveSection2,_super=_createSuper(_default);function _default(){return _classCallCheck(this,_default),_super.apply(this,arguments)}return Constructor=_default,protoProps=[{key:"create",value:function(){this.name="content_actions",this.selectors={ACTIONLINK:"[data-action]",SECTIONLINK:"[data-for='section']",CMLINK:"[data-for='cm']",SECTIONNODE:"[data-for='sectionnode']",MODALTOGGLER:"[data-toggle='collapse']",ADDSECTION:"[data-action='addSection']",CONTENTTREE:"#destination-selector",ACTIONMENU:".action-menu",ACTIONMENUTOGGLER:'[data-toggle="dropdown"]'},this.classes={DISABLED:"disabled"}}},{key:"stateReady",value:function(state){var _this=this;this.addEventListener(this.element,"click",this._dispatchClick),this._checkSectionlist({state:state}),this.addEventListener(this.element,CourseEvents.sectionRefreshed,(function(){return _this._checkSectionlist({state:state})}))}},{key:"getWatchers",value:function(){return[{watch:"course.sectionlist:updated",handler:this._checkSectionlist}]}},{key:"_dispatchClick",value:function(event){var target=event.target.closest(this.selectors.ACTIONLINK);if(target)if(target.classList.contains(this.classes.DISABLED))event.preventDefault();else{var methodName=this._actionMethodName(target.dataset.action);void 0!==this[methodName]&&this[methodName](target,event)}}},{key:"_actionMethodName",value:function(name){var requestName=name.charAt(0).toUpperCase()+name.slice(1);return"_request".concat(requestName)}},{key:"_checkSectionlist",value:function(_ref){var state=_ref.state;this._setAddSectionLocked(state.course.sectionlist.length>state.course.maxsections)}},{key:"_requestMoveSection",value:(_requestMoveSection2=_asyncToGenerator(regeneratorRuntime.mark((function _callee(target,event){var sectionId,sectionInfo,editTools,exporter,data,modalParams,modal,modalBody,currentElement,generalSection,_this2=this;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(sectionId=target.dataset.id){_context.next=3;break}return _context.abrupt("return");case 3:return sectionInfo=this.reactive.get("section",sectionId),event.preventDefault(),editTools=this._getClosestActionMenuToogler(target),exporter=this.reactive.getExporter(),(data=exporter.course(this.reactive.state)).sectionid=sectionInfo.id,data.sectiontitle=sectionInfo.title,modalParams={title:(0,_str.get_string)("movecoursesection","core"),body:_templates.default.render("core_courseformat/local/content/movesection",data)},_context.next=13,this._modalBodyRenderedPromise(modalParams);case 13:modal=_context.sent,modalBody=(0,_normalise.getList)(modal.getBody())[0],currentElement=modalBody.querySelector("".concat(this.selectors.SECTIONLINK,"[data-id='").concat(sectionId,"']")),this._disableLink(currentElement),generalSection=modalBody.querySelector("".concat(this.selectors.SECTIONLINK,"[data-number='0']")),this._disableLink(generalSection),new _contenttree.default(modalBody.querySelector(this.selectors.CONTENTTREE),{SECTION:this.selectors.SECTIONNODE,TOGGLER:this.selectors.MODALTOGGLER,COLLAPSE:this.selectors.MODALTOGGLER},!0),modalBody.addEventListener("click",(function(event){var target=event.target;target.matches("a")&&"section"==target.dataset.for&&void 0!==target.dataset.id&&(target.getAttribute("aria-disabled")||(event.preventDefault(),_this2.reactive.dispatch("sectionMove",[sectionId],target.dataset.id),_this2._destroyModal(modal,editTools)))}));case 21:case"end":return _context.stop()}}),_callee,this)}))),function(_x,_x2){return _requestMoveSection2.apply(this,arguments)})},{key:"_requestMoveCm",value:(_requestMoveCm2=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(target,event){var _toggler$data,cmId,cmInfo,editTools,exporter,data,modalParams,modal,modalBody,currentElement,sectionnode,toggler,collapsibleId,_this3=this;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(cmId=target.dataset.id){_context2.next=3;break}return _context2.abrupt("return");case 3:return cmInfo=this.reactive.get("cm",cmId),event.preventDefault(),editTools=this._getClosestActionMenuToogler(target),exporter=this.reactive.getExporter(),(data=exporter.course(this.reactive.state)).cmid=cmInfo.id,data.cmname=cmInfo.name,modalParams={title:(0,_str.get_string)("movecoursemodule","core"),body:_templates.default.render("core_courseformat/local/content/movecm",data)},_context2.next=13,this._modalBodyRenderedPromise(modalParams);case 13:modal=_context2.sent,modalBody=(0,_normalise.getList)(modal.getBody())[0],currentElement=modalBody.querySelector("".concat(this.selectors.CMLINK,"[data-id='").concat(cmId,"']")),this._disableLink(currentElement),new _contenttree.default(modalBody.querySelector(this.selectors.CONTENTTREE),{SECTION:this.selectors.SECTIONNODE,TOGGLER:this.selectors.MODALTOGGLER,COLLAPSE:this.selectors.MODALTOGGLER,ENTER:this.selectors.SECTIONLINK}),sectionnode=currentElement.closest(this.selectors.SECTIONNODE),toggler=(0,_jquery.default)(sectionnode).find(this.selectors.MODALTOGGLER),(collapsibleId=null!==(_toggler$data=toggler.data("target"))&&void 0!==_toggler$data?_toggler$data:toggler.attr("href"))&&(collapsibleId=collapsibleId.replace("#",""),(0,_jquery.default)("#".concat(collapsibleId)).collapse("toggle")),modalBody.addEventListener("click",(function(event){var target=event.target;if(target.matches("a")&&void 0!==target.dataset.for&&void 0!==target.dataset.id&&!target.getAttribute("aria-disabled")){var targetSectionId,targetCmId;if(event.preventDefault(),"cm"==target.dataset.for){var dropData=exporter.cmDraggableData(_this3.reactive.state,target.dataset.id);targetSectionId=dropData.sectionid,targetCmId=dropData.nextcmid}else{var section=_this3.reactive.get("section",target.dataset.id);targetSectionId=target.dataset.id,targetCmId=null==section?void 0:section.cmlist[0]}_this3.reactive.dispatch("cmMove",[cmId],targetSectionId,targetCmId),_this3._destroyModal(modal,editTools)}}));case 23:case"end":return _context2.stop()}}),_callee2,this)}))),function(_x3,_x4){return _requestMoveCm2.apply(this,arguments)})},{key:"_requestAddSection",value:(_requestAddSection2=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(target,event){var _target$dataset$id;return regeneratorRuntime.wrap((function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:event.preventDefault(),this.reactive.dispatch("addSection",null!==(_target$dataset$id=target.dataset.id)&&void 0!==_target$dataset$id?_target$dataset$id:0);case 2:case"end":return _context3.stop()}}),_callee3,this)}))),function(_x5,_x6){return _requestAddSection2.apply(this,arguments)})},{key:"_requestDeleteSection",value:(_requestDeleteSection2=_asyncToGenerator(regeneratorRuntime.mark((function _callee4(target,event){var _sectionInfo$cmlist,sectionId,sectionInfo,modalParams,modal,_this4=this;return regeneratorRuntime.wrap((function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:if(sectionId=target.dataset.id){_context4.next=3;break}return _context4.abrupt("return");case 3:if(sectionInfo=this.reactive.get("section",sectionId),event.preventDefault(),!((null!==(_sectionInfo$cmlist=sectionInfo.cmlist)&&void 0!==_sectionInfo$cmlist?_sectionInfo$cmlist:[]).length||sectionInfo.hassummary||sectionInfo.rawtitle)){_context4.next=15;break}return modalParams={title:(0,_str.get_string)("confirm","core"),body:(0,_str.get_string)("confirmdeletesection","moodle",sectionInfo.title),saveButtonText:(0,_str.get_string)("delete","core"),type:_modal_factory.default.types.SAVE_CANCEL},_context4.next=10,this._modalBodyRenderedPromise(modalParams);case 10:return(modal=_context4.sent).getRoot().on(_modal_events.default.save,(function(e){e.preventDefault(),modal.destroy(),_this4.reactive.dispatch("sectionDelete",[sectionId])})),_context4.abrupt("return");case 15:this.reactive.dispatch("sectionDelete",[sectionId]);case 16:case"end":return _context4.stop()}}),_callee4,this)}))),function(_x7,_x8){return _requestDeleteSection2.apply(this,arguments)})},{key:"_setAddSectionLocked",value:function(locked){var _this5=this;this.getElements(this.selectors.ADDSECTION).forEach((function(element){element.classList.toggle(_this5.classes.DISABLED,locked),_this5.setElementLocked(element,locked)}))}},{key:"_disableLink",value:function(element){element&&(element.style.pointerEvents="none",element.style.userSelect="none",element.classList.add(this.classes.DISABLED),element.setAttribute("aria-disabled",!0),element.addEventListener("click",(function(event){return event.preventDefault()})))}},{key:"_modalBodyRenderedPromise",value:function(modalParams){return new Promise((function(resolve,reject){_modal_factory.default.create(modalParams).then((function(modal){modal.setRemoveOnClose(!0),modal.getRoot().on(_modal_events.default.bodyRendered,(function(){resolve(modal)})),void 0!==modalParams.saveButtonText&&modal.setSaveButtonText(modalParams.saveButtonText),modal.show()})).catch((function(){reject("Cannot load modal content")}))}))}},{key:"_destroyModal",value:function(modal,element){modal.hide();var pendingDestroy=new _pending.default("courseformat/actions:destroyModal");element&&element.focus(),setTimeout((function(){modal.destroy(),pendingDestroy.resolve()}),500)}},{key:"_getClosestActionMenuToogler",value:function(element){var actionMenu=element.closest(this.selectors.ACTIONMENU);if(actionMenu)return actionMenu.querySelector(this.selectors.ACTIONMENUTOGGLER)}}],protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),_default}(_reactive.BaseComponent);return _exports.default=_default,_exports.default}));

//# sourceMappingURL=actions.min.js.map