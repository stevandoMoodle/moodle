/**
 * Controls the message drawer.
 *
 * @module     core_message/message_drawer
 * @copyright  2018 Ryan Wyllie <ryan@moodle.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("core_message/message_drawer",["jquery","core/custom_interaction_events","core/pubsub","core_message/message_drawer_view_contact","core_message/message_drawer_view_contacts","core_message/message_drawer_view_conversation","core_message/message_drawer_view_group_info","core_message/message_drawer_view_overview","core_message/message_drawer_view_search","core_message/message_drawer_view_settings","core_message/message_drawer_router","core_message/message_drawer_routes","core_message/message_drawer_events","core_message/message_drawer_helper","core/pending","core/drawer"],(function($,CustomEvents,PubSub,ViewContact,ViewContacts,ViewConversation,ViewGroupInfo,ViewOverview,ViewSearch,ViewSettings,Router,Routes,Events,Helper,Pending,Drawer){var SELECTORS={POPOVER:'[data-region="message-popover-region"]',JUMPTO:'.popover-region [data-region="jumpto"]',PANEL_BODY_CONTAINER:'[data-region="panel-body-container"]',PANEL_HEADER_CONTAINER:'[data-region="panel-header-container"]',VIEW_CONTACT:'[data-region="view-contact"]',VIEW_CONTACTS:'[data-region="view-contacts"]',VIEW_CONVERSATION:'[data-region="view-conversation"]',VIEW_GROUP_INFO:'[data-region="view-group-info"]',VIEW_OVERVIEW:'[data-region="view-overview"]',VIEW_SEARCH:'[data-region="view-search"]',VIEW_SETTINGS:'[data-region="view-settings"]',ROUTES:"[data-route]",ROUTES_BACK:"[data-route-back]",HEADER_CONTAINER:'[data-region="header-container"]',BODY_CONTAINER:'[data-region="body-container"]',FOOTER_CONTAINER:'[data-region="footer-container"]',MESSAGE_POPOVER_REGION:'[data-region="message-popover-region"]',POPOVER_REGION_MESSAGES:'[data-region="popover-region-messages"]',SEARCH_INPUT:'[data-region="view-overview-search-input"]',MESSAGE_TOGGLE:".popover-region-toggle",MESSAGE_USER_BUTTON:document.querySelector("#message-user-button")};let MESSAGE_USER_BUTTON_PRESSED=!1;var routes=[[Routes.VIEW_CONTACT,SELECTORS.VIEW_CONTACT,ViewContact.show,ViewContact.description],[Routes.VIEW_CONTACTS,SELECTORS.VIEW_CONTACTS,ViewContacts.show,ViewContacts.description],[Routes.VIEW_CONVERSATION,SELECTORS.VIEW_CONVERSATION,ViewConversation.show,ViewConversation.description],[Routes.VIEW_GROUP_INFO,SELECTORS.VIEW_GROUP_INFO,ViewGroupInfo.show,ViewGroupInfo.description],[Routes.VIEW_OVERVIEW,SELECTORS.VIEW_OVERVIEW,ViewOverview.show,ViewOverview.description],[Routes.VIEW_SEARCH,SELECTORS.VIEW_SEARCH,ViewSearch.show,ViewSearch.description],[Routes.VIEW_SETTINGS,SELECTORS.VIEW_SETTINGS,ViewSettings.show,ViewSettings.description]],createRoutes=function(namespace,root){routes.forEach((function(route){Router.add(namespace,route[0],function(namespace,root,selector){var header=root.find(SELECTORS.HEADER_CONTAINER).find(selector);header.length||(header=root.find(SELECTORS.PANEL_HEADER_CONTAINER).find(selector));var body=root.find(SELECTORS.BODY_CONTAINER).find(selector);body.length||(body=root.find(SELECTORS.PANEL_BODY_CONTAINER).find(selector));var footer=root.find(SELECTORS.FOOTER_CONTAINER).find(selector);return[namespace,header.length?header:null,body.length?body:null,footer.length?footer:null]}(namespace,root,route[1]),route[2],route[3])}))};const getPopoverRoot=contentRoot=>contentRoot.closest(SELECTORS.MESSAGE_POPOVER_REGION),show=function(namespace,root,messagePopover){root.attr("data-shown")||(Router.go(namespace,Routes.VIEW_OVERVIEW),root.attr("data-shown",!0));const drawerRoot=getPopoverRoot(root);var _SELECTORS$MESSAGE_US;(drawerRoot.length&&(Drawer.show(drawerRoot),null==messagePopover||messagePopover.classList.remove("collapsed")),MESSAGE_USER_BUTTON_PRESSED)&&(null===(_SELECTORS$MESSAGE_US=SELECTORS.MESSAGE_USER_BUTTON)||void 0===_SELECTORS$MESSAGE_US||_SELECTORS$MESSAGE_US.classList.add("active"))},hide=function(root,messagePopover){const drawerRoot=getPopoverRoot(root);if(drawerRoot.length){if(Drawer.hide(drawerRoot),null==messagePopover||messagePopover.classList.add("collapsed"),SELECTORS.MESSAGE_USER_BUTTON){const messageUserButton=SELECTORS.MESSAGE_USER_BUTTON.querySelector("span.header-button-title");null==messageUserButton||messageUserButton.classList.remove("active")}var _SELECTORS$MESSAGE_US2;if(MESSAGE_USER_BUTTON_PRESSED)null===(_SELECTORS$MESSAGE_US2=SELECTORS.MESSAGE_USER_BUTTON)||void 0===_SELECTORS$MESSAGE_US2||_SELECTORS$MESSAGE_US2.classList.remove("active"),SELECTORS.MESSAGE_USER_BUTTON.nextSibling.setAttribute("tabindex",-1),MESSAGE_USER_BUTTON_PRESSED=!1}};var isVisible=function(root){const drawerRoot=getPopoverRoot(root);return!drawerRoot.length||Drawer.isVisible(drawerRoot)},setJumpFrom=function(buttonid){document.querySelector(SELECTORS.POPOVER).setAttribute("data-origin",buttonid)};return{init:function(root,uniqueId,alwaysVisible,route){if(root=$(root),createRoutes(uniqueId,root),function(namespace,root,alwaysVisible){CustomEvents.define(root,[CustomEvents.events.activate]);var paramRegex=/^data-route-param-?(\d*)$/;if(root.on(CustomEvents.events.activate,SELECTORS.ROUTES,(function(e,data){for(var element=$(e.target).closest(SELECTORS.ROUTES),route=element.attr("data-route"),attributes=[],i=0;i<element[0].attributes.length;i++)attributes.push(element[0].attributes[i]);var paramAttributes=attributes.filter((function(attribute){var name=attribute.nodeName;return paramRegex.test(name)}));paramAttributes.sort((function(a,b){var aParts=paramRegex.exec(a.nodeName),bParts=paramRegex.exec(b.nodeName),aIndex=aParts.length>1?aParts[1]:0,bIndex=bParts.length>1?bParts[1]:0;return aIndex<bIndex?-1:bIndex<aIndex?1:0}));var params=paramAttributes.map((function(attribute){return attribute.nodeValue})),routeParams=[namespace,route].concat(params);Router.go.apply(null,routeParams),data.originalEvent.preventDefault()})),root.on(CustomEvents.events.activate,SELECTORS.ROUTES_BACK,(function(e,data){Router.back(namespace),data.originalEvent.preventDefault()})),root.on("hide.bs.collapse",".collapse",(function(e){var pendingPromise=new Pending;$(e.target).one("hidden.bs.collapse",(function(){pendingPromise.resolve()}))})),root.on("show.bs.collapse",".collapse",(function(e){var pendingPromise=new Pending;$(e.target).one("shown.bs.collapse",(function(){pendingPromise.resolve()}))})),$(SELECTORS.JUMPTO).focus((function(){if(document.querySelector(SELECTORS.VIEW_OVERVIEW).classList.contains("hidden"))document.querySelector(SELECTORS.HEADER_CONTAINER).childNodes.forEach((container=>{"#text"===container.nodeName||container.classList.contains("hidden")||container.querySelector(SELECTORS.ROUTES_BACK).focus()}));else{const firstInput=root.find(SELECTORS.SEARCH_INPUT);firstInput.length&&firstInput.focus()}})),$(SELECTORS.POPOVER).focus((function(){var button=$(this).attr("data-origin");button&&$("#"+button).focus()})),!alwaysVisible){PubSub.subscribe(Events.SHOW,(function(){show(namespace,root)})),PubSub.subscribe(Events.HIDE,(function(){hide(root)})),PubSub.subscribe(Events.TOGGLE_VISIBILITY,(function(buttonid){const messagePopover=document.getElementById(buttonid).parentElement;isVisible(root)?(hide(root,messagePopover),$(SELECTORS.JUMPTO).attr("tabindex",-1)):(show(namespace,root,messagePopover),setJumpFrom(buttonid),$(SELECTORS.JUMPTO).attr("tabindex",0))}));let isExpanded=!1;document.addEventListener("keydown",(async e=>{"Escape"===e.key&&(e.target.dataset.toggle?isExpanded="false"!==e.target.getAttribute("aria-expanded"):e.target.parentElement.classList.contains("dropdown-menu")&&(isExpanded=!0))})),document.addEventListener("keyup",(async e=>{if("Escape"===e.key&&!isExpanded){const messagePopover=document.querySelector(SELECTORS.POPOVER_REGION_MESSAGES);messagePopover&&isVisible(root)&&(document.activeElement.blur(),document.querySelector(SELECTORS.JUMPTO).setAttribute("tabindex",-1),MESSAGE_USER_BUTTON_PRESSED?SELECTORS.MESSAGE_USER_BUTTON.focus():document.querySelector("".concat(SELECTORS.POPOVER_REGION_MESSAGES," ").concat(SELECTORS.MESSAGE_TOGGLE)).focus(),hide(root,messagePopover))}})),document.addEventListener("click",(e=>{const target=e.target,messagePopover=document.querySelector(SELECTORS.POPOVER_REGION_MESSAGES),messageUserButton=SELECTORS.MESSAGE_USER_BUTTON;if(messagePopover){const rootElement=root[0];rootElement===target||null!=rootElement&&rootElement.contains(target)||messagePopover===target||null!=messagePopover&&messagePopover.contains(target)||messageUserButton===target||null!=messageUserButton&&messageUserButton.contains(target)||hide(root,messagePopover)}}))}PubSub.subscribe(Events.SHOW_CONVERSATION,(function(args){MESSAGE_USER_BUTTON_PRESSED=!0,setJumpFrom(args.buttonid),show(namespace,root),Router.go(namespace,Routes.VIEW_CONVERSATION,args.conversationid)})),PubSub.subscribe(Events.CREATE_CONVERSATION_WITH_USER,(async function(args){MESSAGE_USER_BUTTON_PRESSED=!0,setJumpFrom(args.buttonid),show(namespace,root),Router.go(namespace,Routes.VIEW_CONVERSATION,null,"create",args.userid)})),PubSub.subscribe(Events.SHOW_SETTINGS,(function(){show(namespace,root),Router.go(namespace,Routes.VIEW_SETTINGS)})),PubSub.subscribe(Events.PREFERENCES_UPDATED,(function(preferences){var filteredPreferences=preferences.filter((function(preference){return"message_entertosend"==preference.type})),enterToSendPreference=filteredPreferences.length?filteredPreferences[0]:null;enterToSendPreference&&root.find(SELECTORS.FOOTER_CONTAINER).find(SELECTORS.VIEW_CONVERSATION).attr("data-enter-to-send",enterToSendPreference.value)}))}(uniqueId,root,alwaysVisible),alwaysVisible&&(show(uniqueId,root),route)){var routeParams=route.params||[];routeParams=[uniqueId,route.path].concat(routeParams),Router.go.apply(null,routeParams)}Helper.markDrawerReady()}}}));

//# sourceMappingURL=message_drawer.min.js.map